import{$ as N,A as g,E as w,N as T,U as k,Y as v,h as u,hb as p,o as m,q as A,s as d,t as h,tb as U,u as R,ub as l,v as C,vb as _,z as f}from"./chunk-HFA5G4DX.js";function S(s){return s.status!==void 0}var a=function(s){return s.USER_INTERACTION_REQUIRED="USER_INTERACTION_REQUIRED",s.USER_CANCEL="USER_CANCEL",s.NO_NETWORK="NO_NETWORK",s.TRANSIENT_ERROR="TRANSIENT_ERROR",s.PERSISTENT_ERROR="PERSISTENT_ERROR",s.DISABLED="DISABLED",s.ACCOUNT_UNAVAILABLE="ACCOUNT_UNAVAILABLE",s.NESTED_APP_AUTH_UNAVAILABLE="NESTED_APP_AUTH_UNAVAILABLE",s}(a||{});var E=class{constructor(e,t,n,o){this.clientId=e,this.clientCapabilities=t,this.crypto=n,this.logger=o}toNaaTokenRequest(e){let t;e.extraQueryParameters===void 0?t=new Map:t=new Map(Object.entries(e.extraQueryParameters));let o=new v().addClientCapabilitiesToClaims(e.claims,this.clientCapabilities);return{userObjectId:e.account?.homeAccountId,clientId:this.clientId,authority:e.authority,scope:e.scopes.join(" "),correlationId:e.correlationId!==void 0?e.correlationId:this.crypto.createNewGuid(),nonce:e.nonce,claims:w.isEmptyObj(o)?void 0:o,state:e.state,authenticationScheme:e.authenticationScheme||m.BEARER,extraParameters:t}}fromNaaTokenResponse(e,t,n){if(!t.id_token||!t.access_token)throw R(d.nullOrEmptyToken);let o=new Date((n+(t.expires_in||0))*1e3),c=f.extractTokenClaims(t.id_token,this.crypto.base64Decode),i=this.fromNaaAccountInfo(t.account,c);return{authority:t.authority||i.environment,uniqueId:i.localAccountId,tenantId:i.tenantId,scopes:t.scope.split(" "),account:i,idToken:t.id_token!==void 0?t.id_token:"",idTokenClaims:c,accessToken:t.access_token,fromCache:!0,expiresOn:o,tokenType:e.authenticationScheme||m.BEARER,correlationId:e.correlationId,extExpiresOn:o,state:e.state}}fromNaaAccountInfo(e,t){let n=t||e.idTokenClaims,o=e.localAccountId||n?.oid||n?.sub||"",c=e.tenantId||n?.tid||"",i=e.homeAccountId||`${o}.${c}`,I=e.username||n?.preferred_username||"",b=e.name||n?.name;return{homeAccountId:i,environment:e.environment,tenantId:c,username:I,localAccountId:o,name:b,idToken:e.idToken,idTokenClaims:n}}fromBridgeError(e){if(S(e))switch(e.status){case a.USER_CANCEL:return new h(d.userCanceled);case a.NO_NETWORK:return new h(d.noNetworkConnectivity);case a.ACCOUNT_UNAVAILABLE:return new h(d.noAccountFound);case a.DISABLED:return new h(d.nestedAppAuthBridgeDisabled);case a.NESTED_APP_AUTH_UNAVAILABLE:return new h(e.code||d.nestedAppAuthBridgeDisabled,e.description);case a.TRANSIENT_ERROR:case a.PERSISTENT_ERROR:return new k(e.code,e.description);case a.USER_INTERACTION_REQUIRED:return new N(e.code,e.description);default:return new A(e.code,e.description)}else return new A("unknown_error","An unknown error occurred")}};var y={unsupportedMethod:{code:"unsupported_method",desc:"The PKCE code challenge and verifier could not be generated."}},r=class s extends A{constructor(e,t){super(e,t),Object.setPrototypeOf(this,s.prototype),this.name="NestedAppAuthError"}static createUnsupportedError(){return new s(y.unsupportedMethod.code,y.unsupportedMethod.desc)}};var P=class s{constructor(e){this.operatingContext=e;let t=this.operatingContext.getBridgeProxy();if(t!==void 0)this.bridgeProxy=t;else throw new Error("unexpected: bridgeProxy is undefined");this.config=e.getConfig(),this.logger=this.operatingContext.getLogger(),this.performanceClient=this.config.telemetry.client,this.browserCrypto=e.isBrowserEnvironment()?new U(this.logger,this.performanceClient):C,this.eventHandler=new _(this.logger,this.browserCrypto),this.nestedAppAuthAdapter=new E(this.config.auth.clientId,this.config.auth.clientCapabilities,this.browserCrypto,this.logger)}getBrowserStorage(){throw r.createUnsupportedError()}getEventHandler(){return this.eventHandler}static createController(e){return u(this,null,function*(){let t=new s(e);return Promise.resolve(t)})}initialize(){return Promise.resolve()}acquireTokenInteractive(e){return u(this,null,function*(){this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_START,p.Popup,e);let t=this.performanceClient.startMeasurement(T.AcquireTokenPopup,e.correlationId);t?.add({nestedAppAuthRequest:!0});try{let n=this.nestedAppAuthAdapter.toNaaTokenRequest(e),o=g.nowSeconds(),c=yield this.bridgeProxy.getTokenInteractive(n),i=this.nestedAppAuthAdapter.fromNaaTokenResponse(n,c,o);return this.operatingContext.setActiveAccount(i.account),this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_SUCCESS,p.Popup,i),t.add({accessTokenSize:i.accessToken.length,idTokenSize:i.idToken.length}),t.end({success:!0,requestId:i.requestId}),i}catch(n){let o=this.nestedAppAuthAdapter.fromBridgeError(n);throw this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_FAILURE,p.Popup,null,n),t.end({errorCode:o.errorCode,subErrorCode:o.subError,success:!1}),o}})}acquireTokenSilentInternal(e){return u(this,null,function*(){this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_START,p.Silent,e);let t=this.performanceClient.startMeasurement(T.SsoSilent,e.correlationId);t?.increment({visibilityChangeCount:0}),t?.add({nestedAppAuthRequest:!0});try{let n=this.nestedAppAuthAdapter.toNaaTokenRequest(e),o=g.nowSeconds(),c=yield this.bridgeProxy.getTokenSilent(n),i=this.nestedAppAuthAdapter.fromNaaTokenResponse(n,c,o);return this.operatingContext.setActiveAccount(i.account),this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_SUCCESS,p.Silent,i),t?.add({accessTokenSize:i.accessToken.length,idTokenSize:i.idToken.length}),t?.end({success:!0,requestId:i.requestId}),i}catch(n){let o=this.nestedAppAuthAdapter.fromBridgeError(n);throw this.eventHandler.emitEvent(l.ACQUIRE_TOKEN_FAILURE,p.Silent,null,n),t?.end({errorCode:o.errorCode,subErrorCode:o.subError,success:!1}),o}})}acquireTokenPopup(e){return u(this,null,function*(){return this.acquireTokenInteractive(e)})}acquireTokenRedirect(e){throw r.createUnsupportedError()}acquireTokenSilent(e){return u(this,null,function*(){return this.acquireTokenSilentInternal(e)})}acquireTokenByCode(e){throw r.createUnsupportedError()}acquireTokenNative(e,t,n){throw r.createUnsupportedError()}acquireTokenByRefreshToken(e,t){throw r.createUnsupportedError()}addEventCallback(e){return this.eventHandler.addEventCallback(e)}removeEventCallback(e){this.eventHandler.removeEventCallback(e)}addPerformanceCallback(e){throw r.createUnsupportedError()}removePerformanceCallback(e){throw r.createUnsupportedError()}enableAccountStorageEvents(){throw r.createUnsupportedError()}disableAccountStorageEvents(){throw r.createUnsupportedError()}getAccount(e){throw r.createUnsupportedError()}getAccountByHomeId(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.homeAccountId===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAccountByLocalId(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.localAccountId===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAccountByUsername(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.username===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAllAccounts(){let e=this.operatingContext.getActiveAccount();return e!==void 0?[this.nestedAppAuthAdapter.fromNaaAccountInfo(e)]:[]}handleRedirectPromise(e){throw r.createUnsupportedError()}loginPopup(e){if(e!==void 0)return this.acquireTokenInteractive(e);throw r.createUnsupportedError()}loginRedirect(e){throw r.createUnsupportedError()}logout(e){throw r.createUnsupportedError()}logoutRedirect(e){throw r.createUnsupportedError()}logoutPopup(e){throw r.createUnsupportedError()}ssoSilent(e){return this.acquireTokenSilentInternal(e)}getTokenCache(){throw r.createUnsupportedError()}getLogger(){return this.logger}setLogger(e){this.logger=e}setActiveAccount(e){this.logger.warning("nestedAppAuth does not support setActiveAccount")}getActiveAccount(){let e=this.operatingContext.getActiveAccount();return e!==void 0?this.nestedAppAuthAdapter.fromNaaAccountInfo(e):null}initializeWrapperLibrary(e,t){}setNavigationClient(e){this.logger.warning("setNavigationClient is not supported in nested app auth")}getConfiguration(){return this.config}isBrowserEnv(){return this.operatingContext.isBrowserEnvironment()}getBrowserCrypto(){return this.browserCrypto}getPerformanceClient(){throw r.createUnsupportedError()}getRedirectResponse(){throw r.createUnsupportedError()}preflightBrowserEnvironmentCheck(e,t){throw r.createUnsupportedError()}clearCache(e){return u(this,null,function*(){throw r.createUnsupportedError()})}hydrateCache(e,t){return u(this,null,function*(){throw r.createUnsupportedError()})}};export{P as NestedAppAuthController};
