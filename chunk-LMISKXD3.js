import{$ as ge,$a as se,A as ht,Aa as Xt,B as R,Ba as Zt,C as oe,Ca as me,D as ne,Da as er,E as we,Ea as tr,F as G,Fa as rr,G as Ot,Ga as ir,H as Ht,Ha as qe,I as Z,Ia as or,J as H,Ja as Ae,K as ce,Ka as nr,L as N,La as sr,M as lt,Ma as ft,N as h,Na as z,O as V,Oa as ar,P as m,Pa as cr,Q as Te,Qa as hr,R as Bt,Ra as lr,S as he,Sa as dr,T as Ut,Ta as gr,U as Be,Ua as ur,V as Ue,Va as te,W as le,Wa as mr,X as dt,Xa as pr,Ya as fr,Z as de,Za as g,_ as Le,_a as P,a as f,aa as Lt,ab as J,b as w,ba as ee,bb as E,c as at,ca as B,cb as Ct,da as gt,db as y,e as xr,ea as ut,eb as j,fa as Ke,fb as Se,g as ct,ga as xe,gb as T,h as d,ha as Kt,hb as u,i as p,ia as xt,j as Me,ja as mt,jb as vt,k as b,ka as Dt,l as _,la as qt,lb as x,m as X,ma as Ft,mb as yt,n as S,na as pt,nb as Cr,o as K,oa as ue,ob as q,p as _e,pa as zt,pb as vr,q as k,qa as De,qb as yr,r as Oe,ra as $t,rb as W,s as M,sa as Gt,sb as It,ta as Vt,tb as Ir,u as O,ua as Yt,ub as v,v as He,va as Wt,vb as wr,w as Pt,wa as Qt,x as Mt,xa as Y,y as _t,ya as Jt,z as ae,za as jt}from"./chunk-HFA5G4DX.js";var pe="storage_not_supported",Fe="stubbed_public_client_application_called",fe="in_mem_redirect_unavailable";var ze={[pe]:"Given storage configuration option was not supported.",[Fe]:"Stub instance of Public Client Application was called. If using msal-react, please ensure context is not used without a provider. For more visit: aka.ms/msaljs/browser-errors",[fe]:"Redirect cannot be supported. In-memory storage was selected and storeAuthStateInCookie=false, which would cause the library to be unable to handle the incoming hash. If you would like to use the redirect API, please use session/localStorage or set storeAuthStateInCookie=true."},ri={storageNotSupportedError:{code:pe,desc:ze[pe]},stubPcaInstanceCalled:{code:Fe,desc:ze[Fe]},inMemRedirectUnavailable:{code:fe,desc:ze[fe]}},wt=class a extends k{constructor(e,t){super(e,t),this.name="BrowserConfigurationAuthError",Object.setPrototypeOf(this,a.prototype)}};function $e(a){return new wt(a,ze[a])}var Ee=class{constructor(e){this.validateWindowStorage(e),this.windowStorage=window[e]}validateWindowStorage(e){if(e!==E.LocalStorage&&e!==E.SessionStorage||!window[e])throw $e(pe)}getItem(e){return this.windowStorage.getItem(e)}setItem(e,t){this.windowStorage.setItem(e,t)}removeItem(e){this.windowStorage.removeItem(e)}getKeys(){return Object.keys(this.windowStorage)}containsKey(e){return this.windowStorage.hasOwnProperty(e)}};function Ge(a,e){if(!e)return null;try{return B.parseRequestState(a,e).libraryState.meta}catch{throw O(M.invalidState)}}var Ce=class a extends he{constructor(e,t,r,i,o){super(e,r,i,o),this.COOKIE_LIFE_MULTIPLIER=24*60*60*1e3,this.cacheConfig=t,this.logger=i,this.internalStorage=new It,this.browserStorage=this.setupBrowserStorage(this.cacheConfig.cacheLocation),this.temporaryCacheStorage=this.setupTemporaryCacheStorage(this.cacheConfig.temporaryCacheLocation,this.cacheConfig.cacheLocation),t.cacheMigrationEnabled&&(this.migrateCacheEntries(),this.createKeyMaps())}setupBrowserStorage(e){switch(e){case E.LocalStorage:case E.SessionStorage:try{return new Ee(e)}catch(t){this.logger.verbose(t);break}}return this.cacheConfig.cacheLocation=E.MemoryStorage,new It}setupTemporaryCacheStorage(e,t){switch(t){case E.LocalStorage:case E.SessionStorage:try{return new Ee(e||E.SessionStorage)}catch(r){return this.logger.verbose(r),this.internalStorage}case E.MemoryStorage:default:return this.internalStorage}}migrateCacheEntries(){let e=`${p.CACHE_PREFIX}.${b.ID_TOKEN}`,t=`${p.CACHE_PREFIX}.${b.CLIENT_INFO}`,r=`${p.CACHE_PREFIX}.${b.ERROR}`,i=`${p.CACHE_PREFIX}.${b.ERROR_DESC}`,o=this.browserStorage.getItem(e),n=this.browserStorage.getItem(t),s=this.browserStorage.getItem(r),c=this.browserStorage.getItem(i),l=[o,n,s,c];[b.ID_TOKEN,b.CLIENT_INFO,b.ERROR,b.ERROR_DESC].forEach((I,A)=>this.migrateCacheEntry(I,l[A]))}migrateCacheEntry(e,t){t&&this.setTemporaryCache(e,t,!0)}createKeyMaps(){this.logger.trace("BrowserCacheManager - createKeyMaps called.");let e=this.getItem(j.ACCOUNT_KEYS),t=this.getItem(`${j.TOKEN_KEYS}.${this.clientId}`);if(e&&t){this.logger.verbose("BrowserCacheManager:createKeyMaps - account and token key maps already exist, skipping migration.");return}this.browserStorage.getKeys().forEach(i=>{if(this.isCredentialKey(i)){let o=this.getItem(i);if(o){let n=this.validateAndParseJson(o);if(n&&n.hasOwnProperty("credentialType"))switch(n.credentialType){case S.ID_TOKEN:if(R.isIdTokenEntity(n)){this.logger.trace("BrowserCacheManager:createKeyMaps - idToken found, saving key to token key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - idToken with key: ${i} found, saving key to token key map`);let s=n,c=this.updateCredentialCacheKey(i,s);this.addTokenKey(c,S.ID_TOKEN);return}else this.logger.trace("BrowserCacheManager:createKeyMaps - key found matching idToken schema with value containing idToken credentialType field but value failed IdTokenEntity validation, skipping."),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - failed idToken validation on key: ${i}`);break;case S.ACCESS_TOKEN:case S.ACCESS_TOKEN_WITH_AUTH_SCHEME:if(R.isAccessTokenEntity(n)){this.logger.trace("BrowserCacheManager:createKeyMaps - accessToken found, saving key to token key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - accessToken with key: ${i} found, saving key to token key map`);let s=n,c=this.updateCredentialCacheKey(i,s);this.addTokenKey(c,S.ACCESS_TOKEN);return}else this.logger.trace("BrowserCacheManager:createKeyMaps - key found matching accessToken schema with value containing accessToken credentialType field but value failed AccessTokenEntity validation, skipping."),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - failed accessToken validation on key: ${i}`);break;case S.REFRESH_TOKEN:if(R.isRefreshTokenEntity(n)){this.logger.trace("BrowserCacheManager:createKeyMaps - refreshToken found, saving key to token key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - refreshToken with key: ${i} found, saving key to token key map`);let s=n,c=this.updateCredentialCacheKey(i,s);this.addTokenKey(c,S.REFRESH_TOKEN);return}else this.logger.trace("BrowserCacheManager:createKeyMaps - key found matching refreshToken schema with value containing refreshToken credentialType field but value failed RefreshTokenEntity validation, skipping."),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - failed refreshToken validation on key: ${i}`);break}}}if(this.isAccountKey(i)){let o=this.getItem(i);if(o){let n=this.validateAndParseJson(o);n&&H.isAccountEntity(n)&&(this.logger.trace("BrowserCacheManager:createKeyMaps - account found, saving key to account key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - account with key: ${i} found, saving key to account key map`),this.addAccountKeyToMap(i))}}})}validateAndParseJson(e){try{let t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}getItem(e){return this.browserStorage.getItem(e)}setItem(e,t){this.browserStorage.setItem(e,t)}getAccount(e,t){this.logger.trace("BrowserCacheManager.getAccount called");let r=this.getCachedAccountEntity(e);return this.updateOutdatedCachedAccount(e,r,t)}getCachedAccountEntity(e){let t=this.getItem(e);if(!t)return this.removeAccountKeyFromMap(e),null;let r=this.validateAndParseJson(t);return!r||!H.isAccountEntity(r)?(this.removeAccountKeyFromMap(e),null):he.toObject(new H,r)}setAccount(e){this.logger.trace("BrowserCacheManager.setAccount called");let t=e.generateAccountKey();this.setItem(t,JSON.stringify(e)),this.addAccountKeyToMap(t)}getAccountKeys(){this.logger.trace("BrowserCacheManager.getAccountKeys called");let e=this.getItem(j.ACCOUNT_KEYS);return e?JSON.parse(e):(this.logger.verbose("BrowserCacheManager.getAccountKeys - No account keys found"),[])}addAccountKeyToMap(e){this.logger.trace("BrowserCacheManager.addAccountKeyToMap called"),this.logger.tracePii(`BrowserCacheManager.addAccountKeyToMap called with key: ${e}`);let t=this.getAccountKeys();t.indexOf(e)===-1?(t.push(e),this.setItem(j.ACCOUNT_KEYS,JSON.stringify(t)),this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key added")):this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key already exists in map")}removeAccountKeyFromMap(e){this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap called"),this.logger.tracePii(`BrowserCacheManager.removeAccountKeyFromMap called with key: ${e}`);let t=this.getAccountKeys(),r=t.indexOf(e);r>-1?(t.splice(r,1),this.setItem(j.ACCOUNT_KEYS,JSON.stringify(t)),this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap account key removed")):this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap key not found in existing map")}removeAccount(e){return d(this,null,function*(){ct(a.prototype,this,"removeAccount").call(this,e),this.removeAccountKeyFromMap(e)})}removeOutdatedAccount(e){this.removeItem(e),this.removeAccountKeyFromMap(e)}removeIdToken(e){super.removeIdToken(e),this.removeTokenKey(e,S.ID_TOKEN)}removeAccessToken(e){return d(this,null,function*(){ct(a.prototype,this,"removeAccessToken").call(this,e),this.removeTokenKey(e,S.ACCESS_TOKEN)})}removeRefreshToken(e){super.removeRefreshToken(e),this.removeTokenKey(e,S.REFRESH_TOKEN)}getTokenKeys(){this.logger.trace("BrowserCacheManager.getTokenKeys called");let e=this.getItem(`${j.TOKEN_KEYS}.${this.clientId}`);if(e){let t=this.validateAndParseJson(e);if(t&&t.hasOwnProperty("idToken")&&t.hasOwnProperty("accessToken")&&t.hasOwnProperty("refreshToken"))return t;this.logger.error("BrowserCacheManager.getTokenKeys - Token keys found but in an unknown format. Returning empty key map.")}else this.logger.verbose("BrowserCacheManager.getTokenKeys - No token keys found");return{idToken:[],accessToken:[],refreshToken:[]}}addTokenKey(e,t){this.logger.trace("BrowserCacheManager addTokenKey called");let r=this.getTokenKeys();switch(t){case S.ID_TOKEN:r.idToken.indexOf(e)===-1&&(this.logger.info("BrowserCacheManager: addTokenKey - idToken added to map"),r.idToken.push(e));break;case S.ACCESS_TOKEN:r.accessToken.indexOf(e)===-1&&(this.logger.info("BrowserCacheManager: addTokenKey - accessToken added to map"),r.accessToken.push(e));break;case S.REFRESH_TOKEN:r.refreshToken.indexOf(e)===-1&&(this.logger.info("BrowserCacheManager: addTokenKey - refreshToken added to map"),r.refreshToken.push(e));break;default:throw this.logger.error(`BrowserCacheManager:addTokenKey - CredentialType provided invalid. CredentialType: ${t}`),O(M.unexpectedCredentialType)}this.setItem(`${j.TOKEN_KEYS}.${this.clientId}`,JSON.stringify(r))}removeTokenKey(e,t){this.logger.trace("BrowserCacheManager removeTokenKey called");let r=this.getTokenKeys();switch(t){case S.ID_TOKEN:this.logger.infoPii(`BrowserCacheManager: removeTokenKey - attempting to remove idToken with key: ${e} from map`);let i=r.idToken.indexOf(e);i>-1?(this.logger.info("BrowserCacheManager: removeTokenKey - idToken removed from map"),r.idToken.splice(i,1)):this.logger.info("BrowserCacheManager: removeTokenKey - idToken does not exist in map. Either it was previously removed or it was never added.");break;case S.ACCESS_TOKEN:this.logger.infoPii(`BrowserCacheManager: removeTokenKey - attempting to remove accessToken with key: ${e} from map`);let o=r.accessToken.indexOf(e);o>-1?(this.logger.info("BrowserCacheManager: removeTokenKey - accessToken removed from map"),r.accessToken.splice(o,1)):this.logger.info("BrowserCacheManager: removeTokenKey - accessToken does not exist in map. Either it was previously removed or it was never added.");break;case S.REFRESH_TOKEN:this.logger.infoPii(`BrowserCacheManager: removeTokenKey - attempting to remove refreshToken with key: ${e} from map`);let n=r.refreshToken.indexOf(e);n>-1?(this.logger.info("BrowserCacheManager: removeTokenKey - refreshToken removed from map"),r.refreshToken.splice(n,1)):this.logger.info("BrowserCacheManager: removeTokenKey - refreshToken does not exist in map. Either it was previously removed or it was never added.");break;default:throw this.logger.error(`BrowserCacheManager:removeTokenKey - CredentialType provided invalid. CredentialType: ${t}`),O(M.unexpectedCredentialType)}this.setItem(`${j.TOKEN_KEYS}.${this.clientId}`,JSON.stringify(r))}getIdTokenCredential(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ID_TOKEN),null;let r=this.validateAndParseJson(t);return!r||!R.isIdTokenEntity(r)?(this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ID_TOKEN),null):(this.logger.trace("BrowserCacheManager.getIdTokenCredential: cache hit"),r)}setIdTokenCredential(e){this.logger.trace("BrowserCacheManager.setIdTokenCredential called");let t=R.generateCredentialKey(e);this.setItem(t,JSON.stringify(e)),this.addTokenKey(t,S.ID_TOKEN)}getAccessTokenCredential(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ACCESS_TOKEN),null;let r=this.validateAndParseJson(t);return!r||!R.isAccessTokenEntity(r)?(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ACCESS_TOKEN),null):(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: cache hit"),r)}setAccessTokenCredential(e){this.logger.trace("BrowserCacheManager.setAccessTokenCredential called");let t=R.generateCredentialKey(e);this.setItem(t,JSON.stringify(e)),this.addTokenKey(t,S.ACCESS_TOKEN)}getRefreshTokenCredential(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.REFRESH_TOKEN),null;let r=this.validateAndParseJson(t);return!r||!R.isRefreshTokenEntity(r)?(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.REFRESH_TOKEN),null):(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: cache hit"),r)}setRefreshTokenCredential(e){this.logger.trace("BrowserCacheManager.setRefreshTokenCredential called");let t=R.generateCredentialKey(e);this.setItem(t,JSON.stringify(e)),this.addTokenKey(t,S.REFRESH_TOKEN)}getAppMetadata(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null;let r=this.validateAndParseJson(t);return!r||!ut.isAppMetadataEntity(e,r)?(this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null):(this.logger.trace("BrowserCacheManager.getAppMetadata: cache hit"),he.toObject(new ut,r))}setAppMetadata(e){this.logger.trace("BrowserCacheManager.setAppMetadata called");let t=e.generateAppMetadataKey();this.setItem(t,JSON.stringify(e))}getServerTelemetry(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null;let r=this.validateAndParseJson(t);return!r||!R.isServerTelemetryEntity(e,r)?(this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null):(this.logger.trace("BrowserCacheManager.getServerTelemetry: cache hit"),r)}setServerTelemetry(e,t){this.logger.trace("BrowserCacheManager.setServerTelemetry called"),this.setItem(e,JSON.stringify(t))}getAuthorityMetadata(e){let t=this.internalStorage.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAuthorityMetadata: called, no cache hit"),null;let r=this.validateAndParseJson(t);return r&&lt.isAuthorityMetadataEntity(e,r)?(this.logger.trace("BrowserCacheManager.getAuthorityMetadata: cache hit"),he.toObject(new lt,r)):null}getAuthorityMetadataKeys(){return this.internalStorage.getKeys().filter(t=>this.isAuthorityMetadata(t))}setWrapperMetadata(e,t){this.internalStorage.setItem(Se.WRAPPER_SKU,e),this.internalStorage.setItem(Se.WRAPPER_VER,t)}getWrapperMetadata(){let e=this.internalStorage.getItem(Se.WRAPPER_SKU)||p.EMPTY_STRING,t=this.internalStorage.getItem(Se.WRAPPER_VER)||p.EMPTY_STRING;return[e,t]}setAuthorityMetadata(e,t){this.logger.trace("BrowserCacheManager.setAuthorityMetadata called"),this.internalStorage.setItem(e,JSON.stringify(t))}getActiveAccount(){let e=this.generateCacheKey(b.ACTIVE_ACCOUNT_FILTERS),t=this.getItem(e);if(!t){this.logger.trace("BrowserCacheManager.getActiveAccount: No active account filters cache schema found, looking for legacy schema");let i=this.generateCacheKey(b.ACTIVE_ACCOUNT),o=this.getItem(i);if(!o)return this.logger.trace("BrowserCacheManager.getActiveAccount: No active account found"),null;let n=this.getAccountInfoFilteredBy({localAccountId:o});return n?(this.logger.trace("BrowserCacheManager.getActiveAccount: Legacy active account cache schema found"),this.logger.trace("BrowserCacheManager.getActiveAccount: Adding active account filters cache schema"),this.setActiveAccount(n),n):null}let r=this.validateAndParseJson(t);return r?(this.logger.trace("BrowserCacheManager.getActiveAccount: Active account filters schema found"),this.getAccountInfoFilteredBy({homeAccountId:r.homeAccountId,localAccountId:r.localAccountId,tenantId:r.tenantId})):(this.logger.trace("BrowserCacheManager.getActiveAccount: No active account found"),null)}setActiveAccount(e){let t=this.generateCacheKey(b.ACTIVE_ACCOUNT_FILTERS),r=this.generateCacheKey(b.ACTIVE_ACCOUNT);if(e){this.logger.verbose("setActiveAccount: Active account set");let i={homeAccountId:e.homeAccountId,localAccountId:e.localAccountId,tenantId:e.tenantId};this.browserStorage.setItem(t,JSON.stringify(i)),this.browserStorage.setItem(r,e.localAccountId)}else this.logger.verbose("setActiveAccount: No account passed, active account not set"),this.browserStorage.removeItem(t),this.browserStorage.removeItem(r)}getThrottlingCache(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null;let r=this.validateAndParseJson(t);return!r||!mt.isThrottlingEntity(e,r)?(this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null):(this.logger.trace("BrowserCacheManager.getThrottlingCache: cache hit"),he.toObject(new mt,r))}setThrottlingCache(e,t){this.logger.trace("BrowserCacheManager.setThrottlingCache called"),this.setItem(e,JSON.stringify(t))}getTemporaryCache(e,t){let r=t?this.generateCacheKey(e):e;if(this.cacheConfig.storeAuthStateInCookie){let o=this.getItemCookie(r);if(o)return this.logger.trace("BrowserCacheManager.getTemporaryCache: storeAuthStateInCookies set to true, retrieving from cookies"),o}let i=this.temporaryCacheStorage.getItem(r);if(!i){if(this.cacheConfig.cacheLocation===E.LocalStorage){let o=this.browserStorage.getItem(r);if(o)return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item found in local storage"),o}return this.logger.trace("BrowserCacheManager.getTemporaryCache: No cache item found in local storage"),null}return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item returned"),i}setTemporaryCache(e,t,r){let i=r?this.generateCacheKey(e):e;this.temporaryCacheStorage.setItem(i,t),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.setTemporaryCache: storeAuthStateInCookie set to true, setting item cookie"),this.setItemCookie(i,t))}removeItem(e){this.browserStorage.removeItem(e),this.temporaryCacheStorage.removeItem(e),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.removeItem: storeAuthStateInCookie is true, clearing item cookie"),this.clearItemCookie(e))}containsKey(e){return this.browserStorage.containsKey(e)||this.temporaryCacheStorage.containsKey(e)}getKeys(){return[...this.browserStorage.getKeys(),...this.temporaryCacheStorage.getKeys()]}clear(){return d(this,null,function*(){yield this.removeAllAccounts(),this.removeAppMetadata(),this.getKeys().forEach(e=>{(this.browserStorage.containsKey(e)||this.temporaryCacheStorage.containsKey(e))&&(e.indexOf(p.CACHE_PREFIX)!==-1||e.indexOf(this.clientId)!==-1)&&this.removeItem(e)}),this.internalStorage.clear()})}clearTokensAndKeysWithClaims(e){return d(this,null,function*(){e.addQueueMeasurement(h.ClearTokensAndKeysWithClaims);let t=this.getTokenKeys(),r=[];t.accessToken.forEach(i=>{let o=this.getAccessTokenCredential(i);o?.requestedClaimsHash&&i.includes(o.requestedClaimsHash.toLowerCase())&&r.push(this.removeAccessToken(i))}),yield Promise.all(r),r.length>0&&this.logger.warning(`${r.length} access tokens with claims in the cache keys have been removed from the cache.`)})}setItemCookie(e,t,r){let i=`${encodeURIComponent(e)}=${encodeURIComponent(t)};path=/;SameSite=Lax;`;if(r){let o=this.getCookieExpirationTime(r);i+=`expires=${o};`}this.cacheConfig.secureCookies&&(i+="Secure;"),document.cookie=i}getItemCookie(e){let t=`${encodeURIComponent(e)}=`,r=document.cookie.split(";");for(let i=0;i<r.length;i++){let o=r[i];for(;o.charAt(0)===" ";)o=o.substring(1);if(o.indexOf(t)===0)return decodeURIComponent(o.substring(t.length,o.length))}return p.EMPTY_STRING}clearMsalCookies(){let e=`${p.CACHE_PREFIX}.${this.clientId}`;document.cookie.split(";").forEach(r=>{for(;r.charAt(0)===" ";)r=r.substring(1);if(r.indexOf(e)===0){let i=r.split("=")[0];this.clearItemCookie(i)}})}clearItemCookie(e){this.setItemCookie(e,p.EMPTY_STRING,-1)}getCookieExpirationTime(e){let t=new Date;return new Date(t.getTime()+e*this.COOKIE_LIFE_MULTIPLIER).toUTCString()}getCache(){return this.browserStorage}setCache(){}generateCacheKey(e){return this.validateAndParseJson(e)?JSON.stringify(e):we.startsWith(e,p.CACHE_PREFIX)||we.startsWith(e,b.ADAL_ID_TOKEN)?e:`${p.CACHE_PREFIX}.${this.clientId}.${e}`}generateAuthorityKey(e){let{libraryState:{id:t}}=B.parseRequestState(this.cryptoImpl,e);return this.generateCacheKey(`${y.AUTHORITY}.${t}`)}generateNonceKey(e){let{libraryState:{id:t}}=B.parseRequestState(this.cryptoImpl,e);return this.generateCacheKey(`${y.NONCE_IDTOKEN}.${t}`)}generateStateKey(e){let{libraryState:{id:t}}=B.parseRequestState(this.cryptoImpl,e);return this.generateCacheKey(`${y.REQUEST_STATE}.${t}`)}getCachedAuthority(e){let t=this.generateStateKey(e),r=this.getTemporaryCache(t);if(!r)return null;let i=this.generateAuthorityKey(r);return this.getTemporaryCache(i)}updateCacheEntries(e,t,r,i,o){this.logger.trace("BrowserCacheManager.updateCacheEntries called");let n=this.generateStateKey(e);this.setTemporaryCache(n,e,!1);let s=this.generateNonceKey(e);this.setTemporaryCache(s,t,!1);let c=this.generateAuthorityKey(e);if(this.setTemporaryCache(c,r,!1),o){let l={credential:o.homeAccountId,type:le.HOME_ACCOUNT_ID};this.setTemporaryCache(y.CCS_CREDENTIAL,JSON.stringify(l),!0)}else if(i){let l={credential:i,type:le.UPN};this.setTemporaryCache(y.CCS_CREDENTIAL,JSON.stringify(l),!0)}}resetRequestCache(e){this.logger.trace("BrowserCacheManager.resetRequestCache called"),e&&(this.getKeys().forEach(t=>{t.indexOf(e)!==-1&&this.removeItem(t)}),this.removeItem(this.generateStateKey(e)),this.removeItem(this.generateNonceKey(e)),this.removeItem(this.generateAuthorityKey(e))),this.removeItem(this.generateCacheKey(y.REQUEST_PARAMS)),this.removeItem(this.generateCacheKey(y.ORIGIN_URI)),this.removeItem(this.generateCacheKey(y.URL_HASH)),this.removeItem(this.generateCacheKey(y.CORRELATION_ID)),this.removeItem(this.generateCacheKey(y.CCS_CREDENTIAL)),this.removeItem(this.generateCacheKey(y.NATIVE_REQUEST)),this.setInteractionInProgress(!1)}cleanRequestByState(e){if(this.logger.trace("BrowserCacheManager.cleanRequestByState called"),e){let t=this.generateStateKey(e),r=this.temporaryCacheStorage.getItem(t);this.logger.infoPii(`BrowserCacheManager.cleanRequestByState: Removing temporary cache items for state: ${r}`),this.resetRequestCache(r||p.EMPTY_STRING)}this.clearMsalCookies()}cleanRequestByInteractionType(e){this.logger.trace("BrowserCacheManager.cleanRequestByInteractionType called"),this.getKeys().forEach(t=>{if(t.indexOf(y.REQUEST_STATE)===-1)return;let r=this.temporaryCacheStorage.getItem(t);if(!r)return;let i=Ge(this.cryptoImpl,r);i&&i.interactionType===e&&(this.logger.infoPii(`BrowserCacheManager.cleanRequestByInteractionType: Removing temporary cache items for state: ${r}`),this.resetRequestCache(r))}),this.clearMsalCookies(),this.setInteractionInProgress(!1)}cacheCodeRequest(e){this.logger.trace("BrowserCacheManager.cacheCodeRequest called");let t=Cr(JSON.stringify(e));this.setTemporaryCache(y.REQUEST_PARAMS,t,!0)}getCachedRequest(e){this.logger.trace("BrowserCacheManager.getCachedRequest called");let t=this.getTemporaryCache(y.REQUEST_PARAMS,!0);if(!t)throw g(rr);let r;try{r=JSON.parse(q(t))}catch(i){throw this.logger.errorPii(`Attempted to parse: ${t}`),this.logger.error(`Parsing cached token request threw with error: ${i}`),g(ir)}if(this.removeItem(this.generateCacheKey(y.REQUEST_PARAMS)),!r.authority){let i=this.generateAuthorityKey(e),o=this.getTemporaryCache(i);if(!o)throw g(qe);r.authority=o}return r}getCachedNativeRequest(){this.logger.trace("BrowserCacheManager.getCachedNativeRequest called");let e=this.getTemporaryCache(y.NATIVE_REQUEST,!0);if(!e)return this.logger.trace("BrowserCacheManager.getCachedNativeRequest: No cached native request found"),null;let t=this.validateAndParseJson(e);return t||(this.logger.error("BrowserCacheManager.getCachedNativeRequest: Unable to parse native request"),null)}isInteractionInProgress(e){let t=this.getInteractionInProgress();return e?t===this.clientId:!!t}getInteractionInProgress(){let e=`${p.CACHE_PREFIX}.${y.INTERACTION_STATUS_KEY}`;return this.getTemporaryCache(e,!1)}setInteractionInProgress(e){let t=`${p.CACHE_PREFIX}.${y.INTERACTION_STATUS_KEY}`;if(e){if(this.getInteractionInProgress())throw g(Yt);this.setTemporaryCache(t,this.clientId,!1)}else!e&&this.getInteractionInProgress()===this.clientId&&this.removeItem(t)}getLegacyLoginHint(){let e=this.getTemporaryCache(b.ADAL_ID_TOKEN);e&&(this.browserStorage.removeItem(b.ADAL_ID_TOKEN),this.logger.verbose("Cached ADAL id token retrieved."));let t=this.getTemporaryCache(b.ID_TOKEN,!0);t&&(this.removeItem(this.generateCacheKey(b.ID_TOKEN)),this.logger.verbose("Cached MSAL.js v1 id token retrieved"));let r=t||e;if(r){let i=ae.extractTokenClaims(r,q);if(i.preferred_username)return this.logger.verbose("No SSO params used and ADAL/MSAL v1 token retrieved, setting ADAL/MSAL v1 preferred_username as loginHint"),i.preferred_username;if(i.upn)return this.logger.verbose("No SSO params used and ADAL/MSAL v1 token retrieved, setting ADAL/MSAL v1 upn as loginHint"),i.upn;this.logger.verbose("No SSO params used and ADAL/MSAL v1 token retrieved, however, no account hint claim found. Enable preferred_username or upn id token claim to get SSO.")}return null}updateCredentialCacheKey(e,t){let r=R.generateCredentialKey(t);if(e!==r){let i=this.getItem(e);if(i)return this.removeItem(e),this.setItem(r,i),this.logger.verbose(`Updated an outdated ${t.credentialType} cache key`),r;this.logger.error(`Attempted to update an outdated ${t.credentialType} cache key but no item matching the outdated key was found in storage`)}return e}getRedirectRequestContext(){return this.getTemporaryCache(y.REDIRECT_CONTEXT,!0)}setRedirectRequestContext(e){this.setTemporaryCache(y.REDIRECT_CONTEXT,e,!0)}hydrateCache(e,t){return d(this,null,function*(){let r=R.createIdTokenEntity(e.account?.homeAccountId,e.account?.environment,e.idToken,this.clientId,e.tenantId),i;t.claims&&(i=yield this.cryptoImpl.hashString(t.claims));let o=R.createAccessTokenEntity(e.account?.homeAccountId,e.account.environment,e.accessToken,this.clientId,e.tenantId,e.scopes.join(" "),e.expiresOn?.getTime()||0,e.extExpiresOn?.getTime()||0,q,void 0,e.tokenType,void 0,t.sshKid,t.claims,i),n=new ee(void 0,r,o);return this.saveCacheRecord(n)})}},Tr=(a,e)=>{let t={cacheLocation:E.MemoryStorage,temporaryCacheLocation:E.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1};return new Ce(a,t,He,e)};var Dr={};xr(Dr,{blockAPICallsBeforeInitialize:()=>Ve,blockAcquireTokenInPopups:()=>Rt,blockNonBrowserEnvironment:()=>kt,blockRedirectInIframe:()=>Et,blockReloadInHiddenIframes:()=>ke,clearHash:()=>Tt,getCurrentUri:()=>U,getHomepage:()=>St,isInIframe:()=>Re,isInPopup:()=>Ar,preconnect:()=>be,replaceHash:()=>At});function Tt(a){a.location.hash="",typeof a.history.replaceState=="function"&&a.history.replaceState(null,"",`${a.location.origin}${a.location.pathname}${a.location.search}`)}function At(a){let e=a.split("#");e.shift(),window.location.hash=e.length>0?e.join("#"):""}function Re(){return window.parent!==window}function Ar(){return typeof window<"u"&&!!window.opener&&window.opener!==window&&typeof window.name=="string"&&window.name.indexOf(`${P.POPUP_NAME_PREFIX}.`)===0}function U(){return window.location.href.split("?")[0].split("#")[0]}function St(){let e=new N(window.location.href).getUrlComponents();return`${e.Protocol}//${e.HostNameAndPort}/`}function ke(){if(N.hashContainsKnownProperties(window.location.hash)&&Re())throw g(Xt)}function Et(a,e){let t=Re();if(a===u.Redirect&&t&&!e)throw g(jt)}function Rt(){if(Ar())throw g(Zt)}function kt(a){if(!a)throw g(or)}function Ve(a){if(!a)throw g(mr)}function be(a){let e=document.createElement("link");e.rel="preconnect",e.href=new URL(a).origin,e.crossOrigin="anonymous",document.head.appendChild(e),window.setTimeout(()=>{try{document.head.removeChild(e)}catch{}},1e4)}var Ei="@azure/msal-browser",Ye="3.6.0";var ve=class{constructor(e,t,r,i,o,n,s,c,l){this.config=e,this.browserStorage=t,this.browserCrypto=r,this.networkClient=this.config.system.networkClient,this.eventHandler=o,this.navigationClient=n,this.nativeMessageHandler=c,this.correlationId=l||W(),this.logger=i.clone(P.MSAL_SKU,Ye,this.correlationId),this.performanceClient=s}clearCacheOnLogout(e){return d(this,null,function*(){if(e){H.accountInfoIsEqual(e,this.browserStorage.getActiveAccount(),!1)&&(this.logger.verbose("Setting active account to null"),this.browserStorage.setActiveAccount(null));try{yield this.browserStorage.removeAccount(H.generateAccountCacheKey(e)),this.logger.verbose("Cleared cache items belonging to the account provided in the logout request.")}catch{this.logger.error("Account provided in logout request was not found. Local cache unchanged.")}}else try{this.logger.verbose("No account provided in logout request, clearing all cache items.",this.correlationId),yield this.browserStorage.clear(),yield this.browserCrypto.clearKeystore()}catch{this.logger.error("Attempted to clear all MSAL cache items and failed. Local cache unchanged.")}})}initializeBaseRequest(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.InitializeBaseRequest,this.correlationId);let r=e.authority||this.config.auth.authority;t&&(yield this.validateRequestAuthority(r,t));let i=[...e&&e.scopes||[]],o=w(f({},e),{correlationId:this.correlationId,authority:r,scopes:i});if(!o.authenticationScheme)o.authenticationScheme=K.BEARER,this.logger.verbose(`Authentication Scheme wasn't explicitly set in request, defaulting to "Bearer" request`);else{if(o.authenticationScheme===K.SSH){if(!e.sshJwk)throw ne(oe.missingSshJwk);if(!e.sshKid)throw ne(oe.missingSshKid)}this.logger.verbose(`Authentication Scheme set to "${o.authenticationScheme}" as configured in Auth request`)}return this.config.cache.claimsBasedCachingEnabled&&e.claims&&!we.isEmptyObj(e.claims)&&(o.requestedClaimsHash=yield this.browserCrypto.hashString(e.claims)),o})}getRedirectUri(e){this.logger.verbose("getRedirectUri called");let t=e||this.config.auth.redirectUri||U();return N.getAbsoluteUrl(t,U())}validateRequestAuthority(e,t){return d(this,null,function*(){if(!(yield this.getDiscoveredAuthority(e)).isAlias(t.environment))throw ne(oe.authorityMismatch)})}initializeServerTelemetryManager(e,t){this.logger.verbose("initializeServerTelemetryManager called");let r={clientId:this.config.auth.clientId,correlationId:this.correlationId,apiId:e,forceRefresh:t||!1,wrapperSKU:this.browserStorage.getWrapperMetadata()[0],wrapperVer:this.browserStorage.getWrapperMetadata()[1]};return new qt(r,this.browserStorage)}getDiscoveredAuthority(e){return d(this,null,function*(){this.logger.verbose("getDiscoveredAuthority called");let t={protocolMode:this.config.auth.protocolMode,OIDCOptions:this.config.auth.OIDCOptions,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata};return e?(this.logger.verbose("Creating discovered authority with request authority"),de.createDiscoveredInstance(e,this.config.system.networkClient,this.browserStorage,t,this.logger)):(this.logger.verbose("Creating discovered authority with configured authority"),de.createDiscoveredInstance(this.config.auth.authority,this.config.system.networkClient,this.browserStorage,t,this.logger))})}};var qr=32;function Sr(a,e,t){return d(this,null,function*(){a.addQueueMeasurement(h.GeneratePkceCodes,t);let r=V(Fr,h.GenerateCodeVerifier,e,a,t)(a,e,t),i=yield m(zr,h.GenerateCodeChallengeFromVerifier,e,a,t)(r,a,e,t);return{verifier:r,challenge:i}})}function Fr(a,e,t){try{let r=new Uint8Array(qr);return V(yr,h.GetRandomValues,e,a,t)(r),yt(r)}catch{throw g(pt)}}function zr(a,e,t,r){return d(this,null,function*(){e.addQueueMeasurement(h.GenerateCodeChallengeFromVerifier,r);try{let i=yield m(vr,h.Sha256Digest,t,e,r)(a,e,r);return yt(new Uint8Array(i))}catch{throw g(pt)}})}var L=class extends ve{initializeAuthorizationCodeRequest(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.correlationId);let t=yield m(Sr,h.GeneratePkceCodes,this.logger,this.performanceClient,this.correlationId)(this.performanceClient,this.logger,this.correlationId),r=w(f({},e),{redirectUri:e.redirectUri,code:p.EMPTY_STRING,codeVerifier:t.verifier});return e.codeChallenge=t.challenge,e.codeChallengeMethod=p.S256_CODE_CHALLENGE_METHOD,r})}initializeLogoutRequest(e){this.logger.verbose("initializeLogoutRequest called",e?.correlationId);let t=f({correlationId:this.correlationId||W()},e);if(e)if(e.logoutHint)this.logger.verbose("logoutHint has already been set in logoutRequest");else if(e.account){let r=this.getLogoutHintFromIdTokenClaims(e.account);r&&(this.logger.verbose("Setting logoutHint to login_hint ID Token Claim value for the account provided"),t.logoutHint=r)}else this.logger.verbose("logoutHint was not set and account was not passed into logout request, logoutHint will not be set");else this.logger.verbose("logoutHint will not be set since no logout request was configured");return!e||e.postLogoutRedirectUri!==null?e&&e.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to uri set on logout request",t.correlationId),t.postLogoutRedirectUri=N.getAbsoluteUrl(e.postLogoutRedirectUri,U())):this.config.auth.postLogoutRedirectUri===null?this.logger.verbose("postLogoutRedirectUri configured as null and no uri set on request, not passing post logout redirect",t.correlationId):this.config.auth.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to configured uri",t.correlationId),t.postLogoutRedirectUri=N.getAbsoluteUrl(this.config.auth.postLogoutRedirectUri,U())):(this.logger.verbose("Setting postLogoutRedirectUri to current page",t.correlationId),t.postLogoutRedirectUri=N.getAbsoluteUrl(U(),U())):this.logger.verbose("postLogoutRedirectUri passed as null, not setting post logout redirect uri",t.correlationId),t}getLogoutHintFromIdTokenClaims(e){let t=e.idTokenClaims;if(t){if(t.login_hint)return t.login_hint;this.logger.verbose("The ID Token Claims tied to the provided account do not contain a login_hint claim, logoutHint will not be added to logout request")}else this.logger.verbose("The provided account does not contain ID Token Claims, logoutHint will not be added to logout request");return null}createAuthCodeClient(e,t,r){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientCreateAuthCodeClient,this.correlationId);let i=yield m(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,this.correlationId)(e,t,r);return new xe(i,this.performanceClient)})}getClientConfiguration(e,t,r){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientGetClientConfiguration,this.correlationId);let i=yield m(this.getDiscoveredAuthority.bind(this),h.StandardInteractionClientGetDiscoveredAuthority,this.logger,this.performanceClient,this.correlationId)(t,r),o=this.config.system.loggerOptions;return{authOptions:{clientId:this.config.auth.clientId,authority:i,clientCapabilities:this.config.auth.clientCapabilities},systemOptions:{tokenRenewalOffsetSeconds:this.config.system.tokenRenewalOffsetSeconds,preventCorsPreflight:!0},loggerOptions:{loggerCallback:o.loggerCallback,piiLoggingEnabled:o.piiLoggingEnabled,logLevel:o.logLevel,correlationId:this.correlationId},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.browserCrypto,networkInterface:this.networkClient,storageInterface:this.browserStorage,serverTelemetryManager:e,libraryInfo:{sku:P.MSAL_SKU,version:Ye,cpu:p.EMPTY_STRING,os:p.EMPTY_STRING},telemetry:this.config.telemetry}})}getDiscoveredAuthority(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientGetDiscoveredAuthority,this.correlationId);let r={protocolMode:this.config.auth.protocolMode,OIDCOptions:this.config.auth.OIDCOptions,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache},i=e||this.config.auth.authority,o=Te.generateAuthority(i,t||this.config.auth.azureCloudOptions);return m(de.createDiscoveredInstance.bind(de),h.AuthorityFactoryCreateDiscoveredInstance,this.logger,this.performanceClient,this.correlationId)(o,this.config.system.networkClient,this.browserStorage,r,this.logger,this.performanceClient,this.correlationId)})}initializeAuthorizationRequest(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientInitializeAuthorizationRequest,this.correlationId);let r=this.getRedirectUri(e.redirectUri),i={interactionType:t},o=B.setRequestState(this.browserCrypto,e&&e.state||p.EMPTY_STRING,i),n=yield m(this.initializeBaseRequest.bind(this),h.InitializeBaseRequest,this.logger,this.performanceClient,this.correlationId)(e),s=w(f({},n),{redirectUri:r,state:o,nonce:e.nonce||W(),responseMode:this.config.auth.OIDCOptions.serverResponseType}),c=e.account||this.browserStorage.getActiveAccount();if(c&&(this.logger.verbose("Setting validated request account",this.correlationId),this.logger.verbosePii(`Setting validated request account: ${c.homeAccountId}`,this.correlationId),s.account=c),!s.loginHint&&!c){let l=this.browserStorage.getLegacyLoginHint();l&&(s.loginHint=l)}return s})}};var Er="ContentError",We="user_switch";var Rr="USER_INTERACTION_REQUIRED",kr="USER_CANCEL",br="NO_NETWORK",Nr="PERSISTENT_ERROR",Pr="DISABLED",Mr="ACCOUNT_UNAVAILABLE";var $r=-2147186943,Gr={[We]:"User attempted to switch accounts in the native broker, which is not allowed. All new accounts must sign-in through the standard web flow first, please try again."},$=class a extends k{constructor(e,t,r){super(e,t),Object.setPrototypeOf(this,a.prototype),this.name="NativeAuthError",this.ext=r}};function re(a){if(a.ext&&a.ext.status&&(a.ext.status===Nr||a.ext.status===Pr)||a.ext&&a.ext.error&&a.ext.error===$r)return!0;switch(a.errorCode){case Er:return!0;default:return!1}}function Ne(a,e,t){if(t&&t.status)switch(t.status){case Mr:return Lt(Le.nativeAccountUnavailable);case Rr:return new ge(a,e);case kr:return g(Y);case br:return g(Ae)}return new $(a,Gr[a]||e,t)}var ye=class extends L{acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.SilentCacheClientAcquireToken,e.correlationId);let t=this.initializeServerTelemetryManager(T.acquireTokenSilent_silentFlow),r=yield this.createSilentFlowClient(t,e.authority,e.azureCloudOptions);this.logger.verbose("Silent auth client created");try{let o=(yield m(r.acquireCachedToken.bind(r),h.SilentFlowClientAcquireCachedToken,this.logger,this.performanceClient,e.correlationId)(e))[0];return this.performanceClient.addFields({fromCache:!0},e.correlationId),o}catch(i){throw i instanceof fr&&i.errorCode===ar&&this.logger.verbose("Signing keypair for bound access token not found. Refreshing bound access token and generating a new crypto keypair."),i}})}logout(e){this.logger.verbose("logoutRedirect called");let t=this.initializeLogoutRequest(e);return this.clearCacheOnLogout(t?.account)}createSilentFlowClient(e,t,r){return d(this,null,function*(){let i=yield m(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,this.correlationId)(e,t,r);return new xt(i,this.performanceClient)})}initializeSilentRequest(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.InitializeSilentRequest,this.correlationId);let r=yield m(this.initializeBaseRequest.bind(this),h.InitializeBaseRequest,this.logger,this.performanceClient,this.correlationId)(e,t);return w(f(f({},e),r),{account:t,forceRefresh:e.forceRefresh||!1})})}};var bt={BROKER_CLIENT_ID:"brk_client_id",BROKER_REDIRECT_URI:"brk_redirect_uri"},F=class extends ve{constructor(e,t,r,i,o,n,s,c,l,C,I,A){super(e,t,r,i,o,n,c,l,A),this.apiId=s,this.accountId=C,this.nativeMessageHandler=l,this.nativeStorageManager=I,this.silentCacheClient=new ye(e,this.nativeStorageManager,r,i,o,n,c,l,A)}acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.NativeInteractionClientAcquireToken,e.correlationId),this.logger.trace("NativeInteractionClient - acquireToken called.");let t=this.performanceClient.startMeasurement(h.NativeInteractionClientAcquireToken,e.correlationId),r=ht.nowSeconds(),i=yield this.initializeNativeRequest(e);try{let c=yield this.acquireTokensFromCache(this.accountId,i);return t.end({success:!0,isNativeBroker:!1,fromCache:!0}),c}catch{this.logger.info("MSAL internal Cache does not contain tokens, proceed to make a native call")}let o={method:J.GetToken,request:i},n=yield this.nativeMessageHandler.sendMessage(o),s=this.validateNativeResponse(n);return this.handleNativeResponse(s,i,r).then(c=>(t.end({success:!0,isNativeBroker:!0,requestId:c.requestId}),c)).catch(c=>{throw t.end({success:!1,errorCode:c.errorCode,subErrorCode:c.subError,isNativeBroker:!0}),c})})}createSilentCacheRequest(e,t){return{authority:e.authority,correlationId:this.correlationId,scopes:G.fromString(e.scope).asArray(),account:t,forceRefresh:!1}}acquireTokensFromCache(e,t){return d(this,null,function*(){if(!e)throw this.logger.warning("NativeInteractionClient:acquireTokensFromCache - No nativeAccountId provided"),O(M.noAccountFound);let r=this.browserStorage.getBaseAccountInfo({nativeAccountId:e});if(!r)throw O(M.noAccountFound);try{let i=this.createSilentCacheRequest(t,r),o=yield this.silentCacheClient.acquireToken(i),n=w(f({},r),{idTokenClaims:o?.idTokenClaims});return w(f({},o),{account:n})}catch(i){throw i}})}acquireTokenRedirect(e){return d(this,null,function*(){this.logger.trace("NativeInteractionClient - acquireTokenRedirect called.");let t=yield this.initializeNativeRequest(e),r={method:J.GetToken,request:t};try{let n=yield this.nativeMessageHandler.sendMessage(r);this.validateNativeResponse(n)}catch(n){if(n instanceof $&&re(n))throw n}this.browserStorage.setTemporaryCache(y.NATIVE_REQUEST,JSON.stringify(t),!0);let i={apiId:T.acquireTokenRedirect,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},o=this.config.auth.navigateToLoginRequestUrl?window.location.href:this.getRedirectUri(e.redirectUri);yield this.navigationClient.navigateExternal(o,i)})}handleRedirectPromise(){return d(this,null,function*(){if(this.logger.trace("NativeInteractionClient - handleRedirectPromise called."),!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;let e=this.browserStorage.getCachedNativeRequest();if(!e)return this.logger.verbose("NativeInteractionClient - handleRedirectPromise called but there is no cached request, returning null."),null;let n=e,{prompt:t}=n,r=at(n,["prompt"]);t&&this.logger.verbose("NativeInteractionClient - handleRedirectPromise called and prompt was included in the original request, removing prompt from cached request to prevent second interaction with native broker window."),this.browserStorage.removeItem(this.browserStorage.generateCacheKey(y.NATIVE_REQUEST));let i={method:J.GetToken,request:r},o=ht.nowSeconds();try{this.logger.verbose("NativeInteractionClient - handleRedirectPromise sending message to native broker.");let s=yield this.nativeMessageHandler.sendMessage(i);this.validateNativeResponse(s);let c=this.handleNativeResponse(s,r,o);return this.browserStorage.setInteractionInProgress(!1),yield c}catch(s){throw this.browserStorage.setInteractionInProgress(!1),s}})}logout(){return this.logger.trace("NativeInteractionClient - logout called."),Promise.reject("Logout not implemented yet")}handleNativeResponse(e,t,r){return d(this,null,function*(){if(this.logger.trace("NativeInteractionClient - handleNativeResponse called."),e.account.id!==t.accountId)throw Ne(We);let i=yield this.getDiscoveredAuthority(t.authority),o=ae.extractTokenClaims(e.id_token,q),n=this.createHomeAccountIdentifier(e,o),s=Ke(this.browserStorage,i,n,o,q,e.client_info,o.tid,void 0,e.account.id,this.logger),c=yield this.generateAuthenticationResult(e,t,o,s,i.canonicalAuthority,r);return this.cacheAccount(s),this.cacheNativeTokens(e,t,n,o,c.accessToken,c.tenantId,r),c})}createHomeAccountIdentifier(e,t){return H.generateHomeAccountId(e.client_info||p.EMPTY_STRING,Ht.Default,this.logger,this.browserCrypto,t)}generateScopes(e,t){return e.scope?G.fromString(e.scope):G.fromString(t.scope)}generatePopAccessToken(e,t){return d(this,null,function*(){if(t.tokenType===K.POP){if(e.shr)return this.logger.trace("handleNativeServerResponse: SHR is enabled in native layer"),e.shr;let r=new gt(this.browserCrypto),i={resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,shrNonce:t.shrNonce};if(!t.keyId)throw O(M.keyIdMissing);return r.signPopToken(e.access_token,t.keyId,i)}else return e.access_token})}generateAuthenticationResult(e,t,r,i,o,n){return d(this,null,function*(){let s=this.addTelemetryFromNativeResponse(e),c=e.scope?G.fromString(e.scope):G.fromString(t.scope),l=e.account.properties||{},C=l.UID||r.oid||r.sub||p.EMPTY_STRING,I=l.TenantId||r.tid||p.EMPTY_STRING,A=Ot(i.getAccountInfo(),void 0,r),Q=yield this.generatePopAccessToken(e,t),Ie=t.tokenType===K.POP?K.POP:K.BEARER;return{authority:o,uniqueId:C,tenantId:I,scopes:c.asArray(),account:A,idToken:e.id_token,idTokenClaims:r,accessToken:Q,fromCache:s?this.isResponseFromCache(s):!1,expiresOn:new Date(Number(n+e.expires_in)*1e3),tokenType:Ie,correlationId:this.correlationId,state:e.state,fromNativeBroker:!0}})}cacheAccount(e){this.browserStorage.setAccount(e),this.browserStorage.removeAccountContext(e).catch(t=>{this.logger.error(`Error occurred while removing account context from browser storage. ${t}`)})}cacheNativeTokens(e,t,r,i,o,n,s){let c=R.createIdTokenEntity(r,t.authority,e.id_token||"",t.clientId,i.tid||""),l=t.tokenType===K.POP?p.SHR_NONCE_VALIDITY:(typeof e.expires_in=="string"?parseInt(e.expires_in,10):e.expires_in)||0,C=s+l,I=this.generateScopes(e,t),A=R.createAccessTokenEntity(r,t.authority,o,t.clientId,i.tid||n,I.printScopes(),C,0,q),Q=new ee(void 0,c,A);this.nativeStorageManager.saveCacheRecord(Q,t.storeInCache)}addTelemetryFromNativeResponse(e){let t=this.getMATSFromResponse(e);return t?(this.performanceClient.addFields({extensionId:this.nativeMessageHandler.getExtensionId(),extensionVersion:this.nativeMessageHandler.getExtensionVersion(),matsBrokerVersion:t.broker_version,matsAccountJoinOnStart:t.account_join_on_start,matsAccountJoinOnEnd:t.account_join_on_end,matsDeviceJoin:t.device_join,matsPromptBehavior:t.prompt_behavior,matsApiErrorCode:t.api_error_code,matsUiVisible:t.ui_visible,matsSilentCode:t.silent_code,matsSilentBiSubCode:t.silent_bi_sub_code,matsSilentMessage:t.silent_message,matsSilentStatus:t.silent_status,matsHttpStatus:t.http_status,matsHttpEventCount:t.http_event_count},this.correlationId),t):null}validateNativeResponse(e){if(e.hasOwnProperty("access_token")&&e.hasOwnProperty("id_token")&&e.hasOwnProperty("client_info")&&e.hasOwnProperty("account")&&e.hasOwnProperty("scope")&&e.hasOwnProperty("expires_in"))return e;throw Oe(_e.unexpectedError,"Response missing expected properties.")}getMATSFromResponse(e){if(e.properties.MATS)try{return JSON.parse(e.properties.MATS)}catch{this.logger.error("NativeInteractionClient - Error parsing MATS telemetry, returning null instead")}return null}isResponseFromCache(e){return typeof e.is_cached>"u"?(this.logger.verbose("NativeInteractionClient - MATS telemetry does not contain field indicating if response was served from cache. Returning false."),!1):!!e.is_cached}initializeNativeRequest(e){return d(this,null,function*(){this.logger.trace("NativeInteractionClient - initializeNativeRequest called");let t=e.authority||this.config.auth.authority;e.account&&(yield this.validateRequestAuthority(t,e.account));let r=new N(t);r.validateAsUri();let l=e,{scopes:i}=l,o=at(l,["scopes"]),n=new G(i||[]);n.appendScopes(Me);let s=()=>{switch(this.apiId){case T.ssoSilent:case T.acquireTokenSilent_silentFlow:return this.logger.trace("initializeNativeRequest: silent request sets prompt to none"),_.NONE}if(!e.prompt){this.logger.trace("initializeNativeRequest: prompt was not provided");return}switch(e.prompt){case _.NONE:case _.CONSENT:case _.LOGIN:return this.logger.trace("initializeNativeRequest: prompt is compatible with native flow"),e.prompt;default:throw this.logger.trace(`initializeNativeRequest: prompt = ${e.prompt} is not compatible with native flow`),g(pr)}},c=w(f({},o),{accountId:this.accountId,clientId:this.config.auth.clientId,authority:r.urlString,scope:n.printScopes(),redirectUri:this.getRedirectUri(e.redirectUri),prompt:s(),correlationId:this.correlationId,tokenType:e.authenticationScheme,windowTitleSubstring:document.title,extraParameters:f(f({},e.extraQueryParameters),e.tokenQueryParameters),extendedExpiryToken:!1});if(this.handleExtraBrokerParams(c),c.extraParameters=c.extraParameters||{},c.extraParameters.telemetry=se.MATS_TELEMETRY,e.authenticationScheme===K.POP){let C={resourceRequestUri:e.resourceRequestUri,resourceRequestMethod:e.resourceRequestMethod,shrClaims:e.shrClaims,shrNonce:e.shrNonce},I=new gt(this.browserCrypto),A=yield m(I.generateCnf.bind(I),h.PopTokenGenerateCnf,this.logger,this.performanceClient,this.correlationId)(C,this.logger);c.reqCnf=A.reqCnfHash,c.keyId=A.kid}return c})}handleExtraBrokerParams(e){if(e.extraParameters&&e.extraParameters.hasOwnProperty(bt.BROKER_CLIENT_ID)&&e.extraParameters.hasOwnProperty(bt.BROKER_REDIRECT_URI)&&e.extraParameters.hasOwnProperty(dt.CLIENT_ID)){let t=e.extraParameters[dt.CLIENT_ID],r=e.redirectUri,i=e.extraParameters[bt.BROKER_REDIRECT_URI];e.extraParameters={child_client_id:t,child_redirect_uri:r},e.redirectUri=i}}};var D=class a{constructor(e,t,r,i){this.logger=e,this.handshakeTimeoutMs=t,this.extensionId=i,this.resolvers=new Map,this.handshakeResolvers=new Map,this.messageChannel=new MessageChannel,this.windowListener=this.onWindowMessage.bind(this),this.performanceClient=r,this.handshakeEvent=r.startMeasurement(h.NativeMessageHandlerHandshake)}sendMessage(e){return d(this,null,function*(){this.logger.trace("NativeMessageHandler - sendMessage called.");let t={channel:se.CHANNEL_ID,extensionId:this.extensionId,responseId:W(),body:e};return this.logger.trace("NativeMessageHandler - Sending request to browser extension"),this.logger.tracePii(`NativeMessageHandler - Sending request to browser extension: ${JSON.stringify(t)}`),this.messageChannel.port1.postMessage(t),new Promise((r,i)=>{this.resolvers.set(t.responseId,{resolve:r,reject:i})})})}static createProvider(e,t,r){return d(this,null,function*(){e.trace("NativeMessageHandler - createProvider called.");try{let i=new a(e,t,r,se.PREFERRED_EXTENSION_ID);return yield i.sendHandshakeRequest(),i}catch{let o=new a(e,t,r);return yield o.sendHandshakeRequest(),o}})}sendHandshakeRequest(){return d(this,null,function*(){this.logger.trace("NativeMessageHandler - sendHandshakeRequest called."),window.addEventListener("message",this.windowListener,!1);let e={channel:se.CHANNEL_ID,extensionId:this.extensionId,responseId:W(),body:{method:J.HandshakeRequest}};return this.handshakeEvent.add({extensionId:this.extensionId,extensionHandshakeTimeoutMs:this.handshakeTimeoutMs}),this.messageChannel.port1.onmessage=t=>{this.onChannelMessage(t)},window.postMessage(e,window.origin,[this.messageChannel.port2]),new Promise((t,r)=>{this.handshakeResolvers.set(e.responseId,{resolve:t,reject:r}),this.timeoutId=window.setTimeout(()=>{window.removeEventListener("message",this.windowListener,!1),this.messageChannel.port1.close(),this.messageChannel.port2.close(),this.handshakeEvent.end({extensionHandshakeTimedOut:!0,success:!1}),r(g(gr)),this.handshakeResolvers.delete(e.responseId)},this.handshakeTimeoutMs)})})}onWindowMessage(e){if(this.logger.trace("NativeMessageHandler - onWindowMessage called"),e.source!==window)return;let t=e.data;if(!(!t.channel||t.channel!==se.CHANNEL_ID)&&!(t.extensionId&&t.extensionId!==this.extensionId)&&t.body.method===J.HandshakeRequest){let r=this.handshakeResolvers.get(t.responseId);if(!r){this.logger.trace(`NativeMessageHandler.onWindowMessage - resolver can't be found for request ${t.responseId}`);return}this.logger.verbose(t.extensionId?`Extension with id: ${t.extensionId} not installed`:"No extension installed"),clearTimeout(this.timeoutId),this.messageChannel.port1.close(),this.messageChannel.port2.close(),window.removeEventListener("message",this.windowListener,!1),this.handshakeEvent.end({success:!1,extensionInstalled:!1}),r.reject(g(ur))}}onChannelMessage(e){this.logger.trace("NativeMessageHandler - onChannelMessage called.");let t=e.data,r=this.resolvers.get(t.responseId),i=this.handshakeResolvers.get(t.responseId);try{let o=t.body.method;if(o===J.Response){if(!r)return;let n=t.body.response;if(this.logger.trace("NativeMessageHandler - Received response from browser extension"),this.logger.tracePii(`NativeMessageHandler - Received response from browser extension: ${JSON.stringify(n)}`),n.status!=="Success")r.reject(Ne(n.code,n.description,n.ext));else if(n.result)n.result.code&&n.result.description?r.reject(Ne(n.result.code,n.result.description,n.result.ext)):r.resolve(n.result);else throw Oe(_e.unexpectedError,"Event does not contain result.");this.resolvers.delete(t.responseId)}else if(o===J.HandshakeResponse){if(!i){this.logger.trace(`NativeMessageHandler.onChannelMessage - resolver can't be found for request ${t.responseId}`);return}clearTimeout(this.timeoutId),window.removeEventListener("message",this.windowListener,!1),this.extensionId=t.extensionId,this.extensionVersion=t.body.version,this.logger.verbose(`NativeMessageHandler - Received HandshakeResponse from extension: ${this.extensionId}`),this.handshakeEvent.end({extensionInstalled:!0,success:!0}),i.resolve(),this.handshakeResolvers.delete(t.responseId)}}catch(o){this.logger.error("Error parsing response from WAM Extension"),this.logger.errorPii(`Error parsing response from WAM Extension: ${o}`),this.logger.errorPii(`Unable to parse ${e}`),r?r.reject(o):i&&i.reject(o)}}getExtensionId(){return this.extensionId}getExtensionVersion(){return this.extensionVersion}static isNativeAvailable(e,t,r,i){if(t.trace("isNativeAvailable called"),!e.system.allowNativeBroker)return t.trace("isNativeAvailable: allowNativeBroker is not enabled, returning false"),!1;if(!r)return t.trace("isNativeAvailable: WAM extension provider is not initialized, returning false"),!1;if(i)switch(i){case K.BEARER:case K.POP:return t.trace("isNativeAvailable: authenticationScheme is supported, returning true"),!0;default:return t.trace("isNativeAvailable: authenticationScheme is not supported, returning false"),!1}return!0}};var ie=class{constructor(e,t,r,i,o){this.authModule=e,this.browserStorage=t,this.authCodeRequest=r,this.logger=i,this.performanceClient=o}handleCodeResponse(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.HandleCodeResponse,t.correlationId);let r;try{r=this.authModule.handleFragmentResponse(e,t.state)}catch(i){throw i instanceof Be&&i.subError===Y?g(Y):i}return m(this.handleCodeResponseFromServer.bind(this),h.HandleCodeResponseFromServer,this.logger,this.performanceClient,t.correlationId)(r,t)})}handleCodeResponseFromServer(e,t,r=!0){return d(this,null,function*(){if(this.performanceClient.addQueueMeasurement(h.HandleCodeResponseFromServer,t.correlationId),this.logger.trace("InteractionHandler.handleCodeResponseFromServer called"),this.authCodeRequest.code=e.code,e.cloud_instance_host_name&&(yield m(this.authModule.updateAuthority.bind(this.authModule),h.UpdateTokenEndpointAuthority,this.logger,this.performanceClient,t.correlationId)(e.cloud_instance_host_name,t.correlationId)),r&&(e.nonce=t.nonce||void 0),e.state=t.state,e.client_info)this.authCodeRequest.clientInfo=e.client_info;else{let o=this.createCcsCredentials(t);o&&(this.authCodeRequest.ccsCredential=o)}return yield m(this.authModule.acquireToken.bind(this.authModule),h.AuthClientAcquireToken,this.logger,this.performanceClient,t.correlationId)(this.authCodeRequest,e)})}createCcsCredentials(e){return e.account?{credential:e.account.homeAccountId,type:le.HOME_ACCOUNT_ID}:e.loginHint?{credential:e.loginHint,type:le.UPN}:null}};function Qe(a,e,t){let r=ce.getDeserializedResponse(a);if(!r)throw ce.stripLeadingHashOrQuery(a)?(t.error(`A ${e} is present in the iframe but it does not contain known properties. It's likely that the ${e} has been replaced by code running on the redirectUri page.`),t.errorPii(`The ${e} detected is: ${a}`),g($t)):(t.error(`The request has returned to the redirectUri but a ${e} is not present. It's likely that the ${e} has been removed or the page has been redirected by code running on the redirectUri page.`),g(zt));return r}function _r(a,e,t){if(!a.state)throw g(De);let r=Ge(e,a.state);if(!r)throw g(Gt);if(r.interactionType!==t)throw g(Vt)}var Je=class extends L{constructor(e,t,r,i,o,n,s,c,l,C){super(e,t,r,i,o,n,s,l,C),this.unloadWindow=this.unloadWindow.bind(this),this.nativeStorage=c}acquireToken(e){try{let t=this.generatePopupName(e.scopes||Me,e.authority||this.config.auth.authority),r=e.popupWindowAttributes||{};if(this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true, acquiring token"),this.acquireTokenPopupAsync(e,t,r);{this.logger.verbose("asyncPopup set to false, opening popup before acquiring token");let i=this.openSizedPopup("about:blank",t,r);return this.acquireTokenPopupAsync(e,t,r,i)}}catch(t){return Promise.reject(t)}}logout(e){try{this.logger.verbose("logoutPopup called");let t=this.initializeLogoutRequest(e),r=this.generateLogoutPopupName(t),i=e&&e.authority,o=e&&e.mainWindowRedirectUri,n=e?.popupWindowAttributes||{};if(this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true"),this.logoutPopupAsync(t,r,n,i,void 0,o);{this.logger.verbose("asyncPopup set to false, opening popup");let s=this.openSizedPopup("about:blank",r,n);return this.logoutPopupAsync(t,r,n,i,s,o)}}catch(t){return Promise.reject(t)}}acquireTokenPopupAsync(e,t,r,i){return d(this,null,function*(){this.logger.verbose("acquireTokenPopupAsync called");let o=this.initializeServerTelemetryManager(T.acquireTokenPopup),n=yield m(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,this.correlationId)(e,u.Popup);be(n.authority);try{let s=yield m(this.initializeAuthorizationCodeRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.logger,this.performanceClient,this.correlationId)(n),c=yield m(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(o,n.authority,n.azureCloudOptions),l=D.isNativeAvailable(this.config,this.logger,this.nativeMessageHandler,e.authenticationScheme),C;l&&(C=this.performanceClient.startMeasurement(h.FetchAccountIdWithNativeBroker,e.correlationId));let I=yield c.getAuthCodeUrl(w(f({},n),{nativeBroker:l})),A=new ie(c,this.browserStorage,s,this.logger,this.performanceClient),Q={popup:i,popupName:t,popupWindowAttributes:r},Ie=this.initiateAuthRequest(I,Q);this.eventHandler.emitEvent(v.POPUP_OPENED,u.Popup,{popupWindow:Ie},null);let Nt=yield this.monitorPopupForHash(Ie),st=V(Qe,h.DeserializeResponse,this.logger,this.performanceClient,this.correlationId)(Nt,this.config.auth.OIDCOptions.serverResponseType,this.logger);if(Ue.removeThrottle(this.browserStorage,this.config.auth.clientId,s),st.accountId){if(this.logger.verbose("Account id found in hash, calling WAM for token"),C&&C.end({success:!0,isNativeBroker:!0}),!this.nativeMessageHandler)throw g(te);let Lr=new F(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,T.acquireTokenPopup,this.performanceClient,this.nativeMessageHandler,st.accountId,this.nativeStorage,n.correlationId),{userRequestState:Kr}=B.parseRequestState(this.browserCrypto,n.state);return yield Lr.acquireToken(w(f({},n),{state:Kr,prompt:void 0}))}return yield A.handleCodeResponse(st,n)}catch(s){throw i&&i.close(),s instanceof k&&(s.setCorrelationId(this.correlationId),o.cacheFailedRequest(s)),s}})}logoutPopupAsync(e,t,r,i,o,n){return d(this,null,function*(){this.logger.verbose("logoutPopupAsync called"),this.eventHandler.emitEvent(v.LOGOUT_START,u.Popup,e);let s=this.initializeServerTelemetryManager(T.logoutPopup);try{yield this.clearCacheOnLogout(e.account);let c=yield m(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(s,i);try{c.authority.endSessionEndpoint}catch{if(e.account?.homeAccountId&&e.postLogoutRedirectUri&&c.authority.protocolMode===Z.OIDC){if(this.browserStorage.removeAccount(e.account?.homeAccountId),this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,u.Popup,e),n){let I={apiId:T.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},A=N.getAbsoluteUrl(n,U());yield this.navigationClient.navigateInternal(A,I)}o&&o.close();return}}let l=c.getLogoutUri(e);this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,u.Popup,e);let C=this.openPopup(l,{popupName:t,popupWindowAttributes:r,popup:o});if(this.eventHandler.emitEvent(v.POPUP_OPENED,u.Popup,{popupWindow:C},null),yield this.monitorPopupForHash(C).catch(()=>{}),n){let I={apiId:T.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},A=N.getAbsoluteUrl(n,U());this.logger.verbose("Redirecting main window to url specified in the request"),this.logger.verbosePii(`Redirecting main window to: ${A}`),yield this.navigationClient.navigateInternal(A,I)}else this.logger.verbose("No main window navigation requested")}catch(c){throw o&&o.close(),c instanceof k&&(c.setCorrelationId(this.correlationId),s.cacheFailedRequest(c)),this.browserStorage.setInteractionInProgress(!1),this.eventHandler.emitEvent(v.LOGOUT_FAILURE,u.Popup,null,c),this.eventHandler.emitEvent(v.LOGOUT_END,u.Popup),c}this.eventHandler.emitEvent(v.LOGOUT_END,u.Popup)})}initiateAuthRequest(e,t){if(e)return this.logger.infoPii(`Navigate to: ${e}`),this.openPopup(e,t);throw this.logger.error("Navigate url is empty"),g(ue)}monitorPopupForHash(e){return new Promise((t,r)=>{this.logger.verbose("PopupHandler.monitorPopupForHash - polling started");let i=setInterval(()=>{if(e.closed){this.logger.error("PopupHandler.monitorPopupForHash - window closed"),clearInterval(i),r(g(Y));return}let o="";try{o=e.location.href}catch{}if(!o||o==="about:blank")return;clearInterval(i);let n="",s=this.config.auth.OIDCOptions.serverResponseType;e&&(s===X.QUERY?n=e.location.search:n=e.location.hash),this.logger.verbose("PopupHandler.monitorPopupForHash - popup window is on same origin as caller"),t(n)},this.config.system.pollIntervalMilliseconds)}).finally(()=>{this.cleanPopup(e)})}openPopup(e,t){try{let r;if(t.popup?(r=t.popup,this.logger.verbosePii(`Navigating popup window to: ${e}`),r.location.assign(e)):typeof t.popup>"u"&&(this.logger.verbosePii(`Opening popup window to: ${e}`),r=this.openSizedPopup(e,t.popupName,t.popupWindowAttributes)),!r)throw g(Qt);return r.focus&&r.focus(),this.currentWindow=r,window.addEventListener("beforeunload",this.unloadWindow),r}catch(r){throw this.logger.error("error opening popup "+r.message),this.browserStorage.setInteractionInProgress(!1),g(Wt)}}openSizedPopup(e,t,r){let i=window.screenLeft?window.screenLeft:window.screenX,o=window.screenTop?window.screenTop:window.screenY,n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,s=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,c=r.popupSize?.width,l=r.popupSize?.height,C=r.popupPosition?.top,I=r.popupPosition?.left;return(!c||c<0||c>n)&&(this.logger.verbose("Default popup window width used. Window width not configured or invalid."),c=P.POPUP_WIDTH),(!l||l<0||l>s)&&(this.logger.verbose("Default popup window height used. Window height not configured or invalid."),l=P.POPUP_HEIGHT),(!C||C<0||C>s)&&(this.logger.verbose("Default popup window top position used. Window top not configured or invalid."),C=Math.max(0,s/2-P.POPUP_HEIGHT/2+o)),(!I||I<0||I>n)&&(this.logger.verbose("Default popup window left position used. Window left not configured or invalid."),I=Math.max(0,n/2-P.POPUP_WIDTH/2+i)),window.open(e,t,`width=${c}, height=${l}, top=${C}, left=${I}, scrollbars=yes`)}unloadWindow(e){this.browserStorage.cleanRequestByInteractionType(u.Popup),this.currentWindow&&this.currentWindow.close(),e.preventDefault()}cleanPopup(e){e&&e.close(),window.removeEventListener("beforeunload",this.unloadWindow),this.browserStorage.setInteractionInProgress(!1)}generatePopupName(e,t){return`${P.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${e.join("-")}.${t}.${this.correlationId}`}generateLogoutPopupName(e){let t=e.account&&e.account.homeAccountId;return`${P.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${t}.${this.correlationId}`}};var Pe=class{constructor(e,t,r,i,o){this.authModule=e,this.browserStorage=t,this.authCodeRequest=r,this.logger=i,this.performanceClient=o}initiateAuthRequest(e,t){return d(this,null,function*(){if(this.logger.verbose("RedirectHandler.initiateAuthRequest called"),e){t.redirectStartPage&&(this.logger.verbose("RedirectHandler.initiateAuthRequest: redirectStartPage set, caching start page"),this.browserStorage.setTemporaryCache(y.ORIGIN_URI,t.redirectStartPage,!0)),this.browserStorage.setTemporaryCache(y.CORRELATION_ID,this.authCodeRequest.correlationId,!0),this.browserStorage.cacheCodeRequest(this.authCodeRequest),this.logger.infoPii(`RedirectHandler.initiateAuthRequest: Navigate to: ${e}`);let r={apiId:T.acquireTokenRedirect,timeout:t.redirectTimeout,noHistory:!1};if(typeof t.onRedirectNavigate=="function")if(this.logger.verbose("RedirectHandler.initiateAuthRequest: Invoking onRedirectNavigate callback"),t.onRedirectNavigate(e)!==!1){this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate did not return false, navigating"),yield t.navigationClient.navigateExternal(e,r);return}else{this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate returned false, stopping navigation");return}else{this.logger.verbose("RedirectHandler.initiateAuthRequest: Navigating window to navigate url"),yield t.navigationClient.navigateExternal(e,r);return}}else throw this.logger.info("RedirectHandler.initiateAuthRequest: Navigate url is empty"),g(ue)})}handleCodeResponse(e,t){return d(this,null,function*(){this.logger.verbose("RedirectHandler.handleCodeResponse called"),this.browserStorage.setInteractionInProgress(!1);let r=this.browserStorage.generateStateKey(t),i=this.browserStorage.getTemporaryCache(r);if(!i)throw O(M.stateNotFound,"Cached State");let o;try{o=this.authModule.handleFragmentResponse(e,i)}catch(l){throw l instanceof Be&&l.subError===Y?g(Y):l}let n=this.browserStorage.generateNonceKey(i),s=this.browserStorage.getTemporaryCache(n);if(this.authCodeRequest.code=o.code,o.cloud_instance_host_name&&(yield m(this.authModule.updateAuthority.bind(this.authModule),h.UpdateTokenEndpointAuthority,this.logger,this.performanceClient,this.authCodeRequest.correlationId)(o.cloud_instance_host_name,this.authCodeRequest.correlationId)),o.nonce=s||void 0,o.state=i,o.client_info)this.authCodeRequest.clientInfo=o.client_info;else{let l=this.checkCcsCredentials();l&&(this.authCodeRequest.ccsCredential=l)}let c=yield this.authModule.acquireToken(this.authCodeRequest,o);return this.browserStorage.cleanRequestByState(t),c})}checkCcsCredentials(){let e=this.browserStorage.getTemporaryCache(y.CCS_CREDENTIAL,!0);if(e)try{return JSON.parse(e)}catch{this.authModule.logger.error("Cache credential could not be parsed"),this.authModule.logger.errorPii(`Cache credential could not be parsed: ${e}`)}return null}};var je=class extends L{constructor(e,t,r,i,o,n,s,c,l,C){super(e,t,r,i,o,n,s,l,C),this.nativeStorage=c}acquireToken(e){return d(this,null,function*(){let t=yield m(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,this.correlationId)(e,u.Redirect);this.browserStorage.updateCacheEntries(t.state,t.nonce,t.authority,t.loginHint||"",t.account||null);let r=this.initializeServerTelemetryManager(T.acquireTokenRedirect),i=o=>{o.persisted&&(this.logger.verbose("Page was restored from back/forward cache. Clearing temporary cache."),this.browserStorage.cleanRequestByState(t.state),this.eventHandler.emitEvent(v.RESTORE_FROM_BFCACHE,u.Redirect))};try{let o=yield m(this.initializeAuthorizationCodeRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.logger,this.performanceClient,this.correlationId)(t),n=yield m(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(r,t.authority,t.azureCloudOptions),s=new Pe(n,this.browserStorage,o,this.logger,this.performanceClient),c=yield n.getAuthCodeUrl(w(f({},t),{nativeBroker:D.isNativeAvailable(this.config,this.logger,this.nativeMessageHandler,e.authenticationScheme)})),l=this.getRedirectStartPage(e.redirectStartPage);return this.logger.verbosePii(`Redirect start page: ${l}`),window.addEventListener("pageshow",i),yield s.initiateAuthRequest(c,{navigationClient:this.navigationClient,redirectTimeout:this.config.system.redirectNavigationTimeout,redirectStartPage:l,onRedirectNavigate:e.onRedirectNavigate})}catch(o){throw o instanceof k&&(o.setCorrelationId(this.correlationId),r.cacheFailedRequest(o)),window.removeEventListener("pageshow",i),this.browserStorage.cleanRequestByState(t.state),o}})}handleRedirectPromise(e){return d(this,null,function*(){let t=this.initializeServerTelemetryManager(T.handleRedirectPromise);try{if(!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;let[r,i]=this.getRedirectResponse(e||"");if(!r)return this.logger.info("handleRedirectPromise did not detect a response as a result of a redirect. Cleaning temporary cache."),this.browserStorage.cleanRequestByInteractionType(u.Redirect),null;let o=this.browserStorage.getTemporaryCache(y.ORIGIN_URI,!0)||p.EMPTY_STRING,n=N.removeHashFromUrl(o),s=N.removeHashFromUrl(window.location.href);if(n===s&&this.config.auth.navigateToLoginRequestUrl)return this.logger.verbose("Current page is loginRequestUrl, handling response"),o.indexOf("#")>-1&&At(o),yield this.handleResponse(r,t);if(this.config.auth.navigateToLoginRequestUrl){if(!Re()||this.config.system.allowRedirectInIframe){this.browserStorage.setTemporaryCache(y.URL_HASH,i,!0);let c={apiId:T.handleRedirectPromise,timeout:this.config.system.redirectNavigationTimeout,noHistory:!0},l=!0;if(!o||o==="null"){let C=St();this.browserStorage.setTemporaryCache(y.ORIGIN_URI,C,!0),this.logger.warning("Unable to get valid login request url from cache, redirecting to home page"),l=yield this.navigationClient.navigateInternal(C,c)}else this.logger.verbose(`Navigating to loginRequestUrl: ${o}`),l=yield this.navigationClient.navigateInternal(o,c);if(!l)return yield this.handleResponse(r,t)}}else return this.logger.verbose("NavigateToLoginRequestUrl set to false, handling response"),yield this.handleResponse(r,t);return null}catch(r){throw r instanceof k&&(r.setCorrelationId(this.correlationId),t.cacheFailedRequest(r)),this.browserStorage.cleanRequestByInteractionType(u.Redirect),r}})}getRedirectResponse(e){this.logger.verbose("getRedirectResponseHash called");let t=e;t||(this.config.auth.OIDCOptions.serverResponseType===X.QUERY?t=window.location.search:t=window.location.hash);let r=ce.getDeserializedResponse(t);if(r){try{_r(r,this.browserCrypto,u.Redirect)}catch(o){return o instanceof k&&this.logger.error(`Interaction type validation failed due to ${o.errorCode}: ${o.errorMessage}`),[null,""]}return Tt(window),this.logger.verbose("Hash contains known properties, returning response hash"),[r,t]}let i=this.browserStorage.getTemporaryCache(y.URL_HASH,!0);return this.browserStorage.removeItem(this.browserStorage.generateCacheKey(y.URL_HASH)),i&&(r=ce.getDeserializedResponse(i),r)?(this.logger.verbose("Hash does not contain known properties, returning cached hash"),[r,i]):[null,""]}handleResponse(e,t){return d(this,null,function*(){let r=e.state;if(!r)throw g(De);let i=this.browserStorage.getCachedRequest(r);if(this.logger.verbose("handleResponse called, retrieved cached request"),e.accountId){if(this.logger.verbose("Account id found in hash, calling WAM for token"),!this.nativeMessageHandler)throw g(te);let c=new F(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,T.acquireTokenPopup,this.performanceClient,this.nativeMessageHandler,e.accountId,this.nativeStorage,i.correlationId),{userRequestState:l}=B.parseRequestState(this.browserCrypto,r);return c.acquireToken(w(f({},i),{state:l,prompt:void 0})).finally(()=>{this.browserStorage.cleanRequestByState(r)})}let o=this.browserStorage.getCachedAuthority(r);if(!o)throw g(qe);let n=yield m(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(t,o);return Ue.removeThrottle(this.browserStorage,this.config.auth.clientId,i),new Pe(n,this.browserStorage,i,this.logger,this.performanceClient).handleCodeResponse(e,r)})}logout(e){return d(this,null,function*(){this.logger.verbose("logoutRedirect called");let t=this.initializeLogoutRequest(e),r=this.initializeServerTelemetryManager(T.logout);try{this.eventHandler.emitEvent(v.LOGOUT_START,u.Redirect,e),yield this.clearCacheOnLogout(t.account);let i={apiId:T.logout,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},o=yield m(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(r,e&&e.authority);if(o.authority.protocolMode===Z.OIDC)try{o.authority.endSessionEndpoint}catch{if(t.account?.homeAccountId){this.browserStorage.removeAccount(t.account?.homeAccountId),this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,u.Redirect,t);return}}let n=o.getLogoutUri(t);if(this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,u.Redirect,t),e&&typeof e.onRedirectNavigate=="function")if(e.onRedirectNavigate(n)!==!1){this.logger.verbose("Logout onRedirectNavigate did not return false, navigating"),this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0),yield this.navigationClient.navigateExternal(n,i);return}else this.browserStorage.setInteractionInProgress(!1),this.logger.verbose("Logout onRedirectNavigate returned false, stopping navigation");else{this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0),yield this.navigationClient.navigateExternal(n,i);return}}catch(i){throw i instanceof k&&(i.setCorrelationId(this.correlationId),r.cacheFailedRequest(i)),this.eventHandler.emitEvent(v.LOGOUT_FAILURE,u.Redirect,null,i),this.eventHandler.emitEvent(v.LOGOUT_END,u.Redirect),i}this.eventHandler.emitEvent(v.LOGOUT_END,u.Redirect)})}getRedirectStartPage(e){let t=e||window.location.href;return N.getAbsoluteUrl(t,U())}};var Xe=class a{navigateInternal(e,t){return a.defaultNavigateWindow(e,t)}navigateExternal(e,t){return a.defaultNavigateWindow(e,t)}static defaultNavigateWindow(e,t){return t.noHistory?window.location.replace(e):window.location.assign(e),new Promise(r=>{setTimeout(()=>{r(!0)},t.timeout)})}};var Ze=class{sendGetRequestAsync(e,t){return d(this,null,function*(){let r;try{r=yield fetch(e,{method:Ct.GET,headers:this.getFetchHeaders(t)})}catch{throw window.navigator.onLine?g(sr):g(Ae)}try{return{headers:this.getHeaderDict(r.headers),body:yield r.json(),status:r.status}}catch{throw g(ft)}})}sendPostRequestAsync(e,t){return d(this,null,function*(){let r=t&&t.body||p.EMPTY_STRING,i;try{i=yield fetch(e,{method:Ct.POST,headers:this.getFetchHeaders(t),body:r})}catch{throw window.navigator.onLine?g(nr):g(Ae)}try{return{headers:this.getHeaderDict(i.headers),body:yield i.json(),status:i.status}}catch{throw g(ft)}})}getFetchHeaders(e){let t=new Headers;if(!(e&&e.headers))return t;let r=e.headers;return Object.keys(r).forEach(i=>{t.append(i,r[i])}),t}getHeaderDict(e){let t={};return e.forEach((r,i)=>{t[i]=r}),t}};var Vr=6e4,et=1e4,Yr=3e4,Wr=2e3;function Mn({auth:a,cache:e,system:t,telemetry:r},i){let o={clientId:p.EMPTY_STRING,authority:`${p.DEFAULT_AUTHORITY}`,knownAuthorities:[],cloudDiscoveryMetadata:p.EMPTY_STRING,authorityMetadata:p.EMPTY_STRING,redirectUri:p.EMPTY_STRING,postLogoutRedirectUri:p.EMPTY_STRING,navigateToLoginRequestUrl:!0,clientCapabilities:[],protocolMode:Z.AAD,OIDCOptions:{serverResponseType:X.FRAGMENT,defaultScopes:[p.OPENID_SCOPE,p.PROFILE_SCOPE,p.OFFLINE_ACCESS_SCOPE]},azureCloudOptions:{azureCloudInstance:_t.None,tenant:p.EMPTY_STRING},skipAuthorityMetadataCache:!1,supportsNestedAppAuth:!1},n={cacheLocation:E.SessionStorage,temporaryCacheLocation:E.SessionStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!!(e&&e.cacheLocation===E.LocalStorage),claimsBasedCachingEnabled:!1},s={loggerCallback:()=>{},logLevel:Pt.Info,piiLoggingEnabled:!1},c=w(f({},Ut),{loggerOptions:s,networkClient:i?new Ze:Dt,navigationClient:new Xe,loadFrameTimeout:0,windowHashTimeout:t?.loadFrameTimeout||Vr,iframeHashTimeout:t?.loadFrameTimeout||et,navigateFrameWait:0,redirectNavigationTimeout:Yr,asyncPopups:!1,allowRedirectInIframe:!1,allowNativeBroker:!1,nativeBrokerHandshakeTimeout:t?.nativeBrokerHandshakeTimeout||Wr,pollIntervalMilliseconds:P.DEFAULT_POLL_INTERVAL_MS}),l=w(f(f({},c),t),{loggerOptions:t?.loggerOptions||s}),C={application:{appName:p.EMPTY_STRING,appVersion:p.EMPTY_STRING},client:new Ft};if(a?.protocolMode!==Z.OIDC&&a?.OIDCOptions&&new Mt(l.loggerOptions).warning(JSON.stringify(ne(oe.cannotSetOIDCOptions))),a?.protocolMode&&a.protocolMode!==Z.AAD&&l?.allowNativeBroker)throw ne(oe.cannotAllowNativeBroker);return{auth:w(f(f({},o),a),{OIDCOptions:f(f({},o.OIDCOptions),a?.OIDCOptions)}),cache:f(f({},n),e),system:l,telemetry:f(f({},C),r)}}function Or(a,e,t,r,i){return d(this,null,function*(){if(e.addQueueMeasurement(h.SilentHandlerInitiateAuthRequest,r),!a)throw t.info("Navigate url is empty"),g(ue);return i?m(Qr,h.SilentHandlerLoadFrame,t,e,r)(a,i,e,r):V(Jr,h.SilentHandlerLoadFrameSync,t,e,r)(a)})}function Hr(a,e,t,r,i,o,n){return d(this,null,function*(){return r.addQueueMeasurement(h.SilentHandlerMonitorIframeForHash,o),new Promise((s,c)=>{e<et&&i.warning(`system.loadFrameTimeout or system.iframeHashTimeout set to lower (${e}ms) than the default (${et}ms). This may result in timeouts.`);let l=window.setTimeout(()=>{window.clearInterval(C),c(g(Jt))},e),C=window.setInterval(()=>{let I="",A=a.contentWindow;try{I=A?A.location.href:""}catch{}if(!I||I==="about:blank")return;let Q="";A&&(n===X.QUERY?Q=A.location.search:Q=A.location.hash),window.clearTimeout(l),window.clearInterval(C),s(Q)},t)}).finally(()=>{V(jr,h.RemoveHiddenIframe,i,r,o)(a)})})}function Qr(a,e,t,r){return t.addQueueMeasurement(h.SilentHandlerLoadFrame,r),new Promise((i,o)=>{let n=Br();window.setTimeout(()=>{if(!n){o("Unable to load iframe");return}n.src=a,i(n)},e)})}function Jr(a){let e=Br();return e.src=a,e}function Br(){let a=document.createElement("iframe");return a.style.visibility="hidden",a.style.position="absolute",a.style.width=a.style.height="0",a.style.border="0",a.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),document.body.appendChild(a),a}function jr(a){document.body===a.parentNode&&document.body.removeChild(a)}var tt=class extends L{constructor(e,t,r,i,o,n,s,c,l,C,I){super(e,t,r,i,o,n,c,C,I),this.apiId=s,this.nativeStorage=l}acquireToken(e){return d(this,null,function*(){if(this.performanceClient.addQueueMeasurement(h.SilentIframeClientAcquireToken,e.correlationId),!e.loginHint&&!e.sid&&(!e.account||!e.account.username)&&this.logger.warning("No user hint provided. The authorization server may need more information to complete this request."),e.prompt&&e.prompt!==_.NONE&&e.prompt!==_.NO_SESSION)throw g(tr);let t=yield m(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,e.correlationId)(w(f({},e),{prompt:e.prompt||_.NONE}),u.Silent);be(t.authority);let r=this.initializeServerTelemetryManager(this.apiId);try{let i=yield m(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,e.correlationId)(r,t.authority,t.azureCloudOptions);return yield m(this.silentTokenHelper.bind(this),h.SilentIframeClientTokenHelper,this.logger,this.performanceClient,e.correlationId)(i,t)}catch(i){throw i instanceof k&&(i.setCorrelationId(this.correlationId),r.cacheFailedRequest(i)),i}})}logout(){return Promise.reject(g(me))}silentTokenHelper(e,t){return d(this,null,function*(){let r=t.correlationId;this.performanceClient.addQueueMeasurement(h.SilentIframeClientTokenHelper,r);let i=yield m(this.initializeAuthorizationCodeRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.logger,this.performanceClient,r)(t),o=yield m(e.getAuthCodeUrl.bind(e),h.GetAuthCodeUrl,this.logger,this.performanceClient,r)(w(f({},t),{nativeBroker:D.isNativeAvailable(this.config,this.logger,this.nativeMessageHandler,t.authenticationScheme)})),n=new ie(e,this.browserStorage,i,this.logger,this.performanceClient),s=yield m(Or,h.SilentHandlerInitiateAuthRequest,this.logger,this.performanceClient,r)(o,this.performanceClient,this.logger,r,this.config.system.navigateFrameWait),c=this.config.auth.OIDCOptions.serverResponseType,l=yield m(Hr,h.SilentHandlerMonitorIframeForHash,this.logger,this.performanceClient,r)(s,this.config.system.iframeHashTimeout,this.config.system.pollIntervalMilliseconds,this.performanceClient,this.logger,r,c),C=V(Qe,h.DeserializeResponse,this.logger,this.performanceClient,this.correlationId)(l,c,this.logger);if(C.accountId){if(this.logger.verbose("Account id found in hash, calling WAM for token"),!this.nativeMessageHandler)throw g(te);let I=new F(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.apiId,this.performanceClient,this.nativeMessageHandler,C.accountId,this.browserStorage,r),{userRequestState:A}=B.parseRequestState(this.browserCrypto,t.state);return m(I.acquireToken.bind(I),h.NativeInteractionClientAcquireToken,this.logger,this.performanceClient,r)(w(f({},t),{state:A,prompt:t.prompt||_.NONE}))}return m(n.handleCodeResponse.bind(n),h.HandleCodeResponse,this.logger,this.performanceClient,r)(C,t)})}};var rt=class extends L{acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.SilentRefreshClientAcquireToken,e.correlationId);let t=yield m(this.initializeBaseRequest.bind(this),h.InitializeBaseRequest,this.logger,this.performanceClient,e.correlationId)(e,e.account),r=f(f({},e),t),i=this.initializeServerTelemetryManager(T.acquireTokenSilent_silentFlow),o=yield this.createRefreshTokenClient(i,r.authority,r.azureCloudOptions);return m(o.acquireTokenByRefreshToken.bind(o),h.RefreshTokenClientAcquireTokenByRefreshToken,this.logger,this.performanceClient,e.correlationId)(r).catch(n=>{throw n.setCorrelationId(this.correlationId),i.cacheFailedRequest(n),n})})}logout(){return Promise.reject(g(me))}createRefreshTokenClient(e,t,r){return d(this,null,function*(){let i=yield m(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,this.correlationId)(e,t,r);return new Kt(i,this.performanceClient)})}};var it=class{constructor(e,t,r,i){this.isBrowserEnvironment=typeof window<"u",this.config=e,this.storage=t,this.logger=r,this.cryptoObj=i}loadExternalTokens(e,t,r){if(this.logger.info("TokenCache - loadExternalTokens called"),!t.id_token)throw g(z);let i=ae.extractTokenClaims(t.id_token,q),o,n,s;if(e.account)s=H.createFromAccountInfo(e.account),o=new ee(s,this.loadIdToken(t.id_token,s.homeAccountId,e.account.environment,e.account.tenantId),this.loadAccessToken(e,t,s.homeAccountId,e.account.environment,e.account.tenantId,r),this.loadRefreshToken(e,t,s.homeAccountId,e.account.environment));else if(e.authority){let c=Te.generateAuthority(e.authority,e.azureCloudOptions),l={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache};if(n=new Te(c,this.config.system.networkClient,this.storage,l,this.logger),r.clientInfo)this.logger.trace("TokenCache - homeAccountId from options"),s=this.loadAccount(i,n,r.clientInfo),o=new ee(s,this.loadIdToken(t.id_token,s.homeAccountId,n.hostnameAndPort,n.tenant),this.loadAccessToken(e,t,s.homeAccountId,n.hostnameAndPort,n.tenant,r),this.loadRefreshToken(e,t,s.homeAccountId,n.hostnameAndPort));else if(t.client_info)this.logger.trace("TokenCache - homeAccountId from response"),s=this.loadAccount(i,n,t.client_info),o=new ee(s,this.loadIdToken(t.id_token,s.homeAccountId,n.hostnameAndPort,n.tenant),this.loadAccessToken(e,t,s.homeAccountId,n.hostnameAndPort,n.tenant,r),this.loadRefreshToken(e,t,s.homeAccountId,n.hostnameAndPort));else throw g(z)}else throw g(z);return this.generateAuthenticationResult(e,i,o,s,n)}loadAccount(e,t,r,i){if(this.isBrowserEnvironment){this.logger.verbose("TokenCache - loading account");let o;if(i?o=i:t.authorityType!==void 0&&r&&(o=H.generateHomeAccountId(r,t.authorityType,this.logger,this.cryptoObj,e)),!o)throw g(z);let n=e.tid,s=Ke(this.storage,t,o,e,q,r,n,void 0,void 0,this.logger);return this.storage.setAccount(s),s}else throw g(z)}loadIdToken(e,t,r,i){let o=R.createIdTokenEntity(t,r,e,this.config.auth.clientId,i);if(this.isBrowserEnvironment)return this.logger.verbose("TokenCache - loading id token"),this.storage.setIdTokenCredential(o),o;throw g(z)}loadAccessToken(e,t,r,i,o,n){if(!t.access_token)return this.logger.verbose("TokenCache - No access token provided for caching"),null;if(!t.expires_in)throw g(z);if(!n.extendedExpiresOn)throw g(z);let s=new G(e.scopes).printScopes(),c=n.expiresOn||t.expires_in+new Date().getTime()/1e3,l=n.extendedExpiresOn,C=R.createAccessTokenEntity(r,i,t.access_token,this.config.auth.clientId,o,s,c,l,q);if(this.isBrowserEnvironment)return this.logger.verbose("TokenCache - loading access token"),this.storage.setAccessTokenCredential(C),C;throw g(z)}loadRefreshToken(e,t,r,i){if(!t.refresh_token)return this.logger.verbose("TokenCache - No refresh token provided for caching"),null;let o=R.createRefreshTokenEntity(r,i,t.refresh_token,this.config.auth.clientId);if(this.isBrowserEnvironment)return this.logger.verbose("TokenCache - loading refresh token"),this.storage.setRefreshTokenCredential(o),o;throw g(z)}generateAuthenticationResult(e,t,r,i,o){let n=p.EMPTY_STRING,s=[],c=null,l;r?.accessToken&&(n=r.accessToken.secret,s=G.fromString(r.accessToken.target).asArray(),c=new Date(Number(r.accessToken.expiresOn)*1e3),l=new Date(Number(r.accessToken.extendedExpiresOn)*1e3));let C=t.oid||t.sub||p.EMPTY_STRING,I=t.tid||p.EMPTY_STRING;return{authority:o?o.canonicalAuthority:p.EMPTY_STRING,uniqueId:C,tenantId:I,scopes:s,account:i.getAccountInfo(),idToken:r.idToken?.secret||"",idTokenClaims:t||{},accessToken:n,fromCache:!0,expiresOn:c,correlationId:e.correlationId||p.EMPTY_STRING,requestId:p.EMPTY_STRING,extExpiresOn:l,familyId:p.EMPTY_STRING,tokenType:r?.accessToken?.tokenType||p.EMPTY_STRING,state:p.EMPTY_STRING,cloudGraphHostName:i.cloudGraphHostName||p.EMPTY_STRING,msGraphHost:i.msGraphHost||p.EMPTY_STRING,code:void 0,fromNativeBroker:!1}}};var ot=class extends xe{constructor(e){super(e),this.includeRedirectUri=!1}};var nt=class extends L{constructor(e,t,r,i,o,n,s,c,l,C){super(e,t,r,i,o,n,c,l,C),this.apiId=s}acquireToken(e){return d(this,null,function*(){if(!e.code)throw g(cr);let t=yield m(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,e.correlationId)(e,u.Silent),r=this.initializeServerTelemetryManager(this.apiId);try{let i=w(f({},t),{code:e.code}),o=yield m(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,e.correlationId)(r,t.authority),n=new ot(o);this.logger.verbose("Auth code client created");let s=new ie(n,this.browserStorage,i,this.logger,this.performanceClient);return yield m(s.handleCodeResponseFromServer.bind(s),h.HandleCodeResponseFromServer,this.logger,this.performanceClient,e.correlationId)({code:e.code,msgraph_host:e.msGraphHost,cloud_graph_host_name:e.cloudGraphHostName,cloud_instance_host_name:e.cloudInstanceHostName},t,!1)}catch(i){throw i instanceof k&&(i.setCorrelationId(this.correlationId),r.cacheFailedRequest(i)),i}})}logout(){return Promise.reject(g(me))}};var Ur=class a{constructor(e){this.atsAsyncMeasurement=void 0,this.operatingContext=e,this.isBrowserEnvironment=this.operatingContext.isBrowserEnvironment(),this.config=e.getConfig(),this.initialized=!1,this.logger=this.operatingContext.getLogger(),this.networkClient=this.config.system.networkClient,this.navigationClient=this.config.system.navigationClient,this.redirectResponse=new Map,this.hybridAuthCodeResponses=new Map,this.performanceClient=this.config.telemetry.client,this.browserCrypto=this.isBrowserEnvironment?new Ir(this.logger,this.performanceClient):He,this.eventHandler=new wr(this.logger,this.browserCrypto),this.browserStorage=this.isBrowserEnvironment?new Ce(this.config.auth.clientId,this.config.cache,this.browserCrypto,this.logger,Bt(this.config.auth)):Tr(this.config.auth.clientId,this.logger);let t={cacheLocation:E.MemoryStorage,temporaryCacheLocation:E.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1};this.nativeInternalStorage=new Ce(this.config.auth.clientId,t,this.browserCrypto,this.logger),this.tokenCache=new it(this.config,this.browserStorage,this.logger,this.browserCrypto),this.activeSilentTokenRequests=new Map,this.trackPageVisibility=this.trackPageVisibility.bind(this),this.trackPageVisibilityWithMeasurement=this.trackPageVisibilityWithMeasurement.bind(this)}static createController(e){return d(this,null,function*(){let t=new a(e);return yield t.initialize(),t})}trackPageVisibility(){this.atsAsyncMeasurement&&(this.logger.info("Perf: Visibility change detected"),this.atsAsyncMeasurement.increment({visibilityChangeCount:1}))}initialize(){return d(this,null,function*(){if(this.logger.trace("initialize called"),this.initialized){this.logger.info("initialize has already been called, exiting early.");return}let e=this.config.system.allowNativeBroker,t=this.performanceClient.startMeasurement(h.InitializeClientApplication);if(this.eventHandler.emitEvent(v.INITIALIZE_START),e)try{this.nativeExtensionProvider=yield D.createProvider(this.logger,this.config.system.nativeBrokerHandshakeTimeout,this.performanceClient)}catch(r){this.logger.verbose(r)}this.config.cache.claimsBasedCachingEnabled||(this.logger.verbose("Claims-based caching is disabled. Clearing the previous cache with claims"),yield m(this.browserStorage.clearTokensAndKeysWithClaims.bind(this.browserStorage),h.ClearTokensAndKeysWithClaims,this.logger,this.performanceClient)(this.performanceClient)),this.initialized=!0,this.eventHandler.emitEvent(v.INITIALIZE_END),t.end({allowNativeBroker:e,success:!0})})}handleRedirectPromise(e){return d(this,null,function*(){this.logger.verbose("handleRedirectPromise called"),Ve(this.initialized);let t=this.getAllAccounts();if(this.isBrowserEnvironment){let r=e||"",i=this.redirectResponse.get(r);if(typeof i>"u"){this.eventHandler.emitEvent(v.HANDLE_REDIRECT_START,u.Redirect),this.logger.verbose("handleRedirectPromise has been called for the first time, storing the promise");let o=this.browserStorage.getCachedNativeRequest(),n;if(o&&D.isNativeAvailable(this.config,this.logger,this.nativeExtensionProvider)&&this.nativeExtensionProvider&&!e)this.logger.trace("handleRedirectPromise - acquiring token from native platform"),n=new F(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,T.handleRedirectPromise,this.performanceClient,this.nativeExtensionProvider,o.accountId,this.nativeInternalStorage,o.correlationId).handleRedirectPromise();else{this.logger.trace("handleRedirectPromise - acquiring token from web flow");let s=this.browserStorage.getTemporaryCache(y.CORRELATION_ID,!0)||p.EMPTY_STRING;n=this.createRedirectClient(s).handleRedirectPromise(e)}i=n.then(s=>(s&&(t.length<this.getAllAccounts().length?(this.eventHandler.emitEvent(v.LOGIN_SUCCESS,u.Redirect,s),this.logger.verbose("handleRedirectResponse returned result, login success")):(this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_SUCCESS,u.Redirect,s),this.logger.verbose("handleRedirectResponse returned result, acquire token success"))),this.eventHandler.emitEvent(v.HANDLE_REDIRECT_END,u.Redirect),s)).catch(s=>{throw t.length>0?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,u.Redirect,null,s):this.eventHandler.emitEvent(v.LOGIN_FAILURE,u.Redirect,null,s),this.eventHandler.emitEvent(v.HANDLE_REDIRECT_END,u.Redirect),s}),this.redirectResponse.set(r,i)}else this.logger.verbose("handleRedirectPromise has been called previously, returning the result from the first call");return i}return this.logger.verbose("handleRedirectPromise returns null, not browser environment"),null})}acquireTokenRedirect(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);this.logger.verbose("acquireTokenRedirect called",t),this.preflightBrowserEnvironmentCheck(u.Redirect);let r=this.getAllAccounts().length>0;r?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_START,u.Redirect,e):this.eventHandler.emitEvent(v.LOGIN_START,u.Redirect,e);let i;return this.nativeExtensionProvider&&this.canUseNative(e)?i=new F(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,T.acquireTokenRedirect,this.performanceClient,this.nativeExtensionProvider,this.getNativeAccountId(e),this.nativeInternalStorage,t).acquireTokenRedirect(e).catch(n=>{if(n instanceof $&&re(n))return this.nativeExtensionProvider=void 0,this.createRedirectClient(t).acquireToken(e);if(n instanceof ge)return this.logger.verbose("acquireTokenRedirect - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createRedirectClient(t).acquireToken(e);throw this.getBrowserStorage().setInteractionInProgress(!1),n}):i=this.createRedirectClient(t).acquireToken(e),i.catch(o=>{throw r?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,u.Redirect,null,o):this.eventHandler.emitEvent(v.LOGIN_FAILURE,u.Redirect,null,o),o})})}acquireTokenPopup(e){let t=this.getRequestCorrelationId(e),r=this.performanceClient.startMeasurement(h.AcquireTokenPopup,t);try{this.logger.verbose("acquireTokenPopup called",t),this.preflightBrowserEnvironmentCheck(u.Popup)}catch(n){return Promise.reject(n)}let i=this.getAllAccounts();i.length>0?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_START,u.Popup,e):this.eventHandler.emitEvent(v.LOGIN_START,u.Popup,e);let o;return this.canUseNative(e)?o=this.acquireTokenNative(w(f({},e),{correlationId:t}),T.acquireTokenPopup).then(n=>(this.getBrowserStorage().setInteractionInProgress(!1),r.end({success:!0,isNativeBroker:!0,requestId:n.requestId}),n)).catch(n=>{if(n instanceof $&&re(n))return this.nativeExtensionProvider=void 0,this.createPopupClient(t).acquireToken(e);if(n instanceof ge)return this.logger.verbose("acquireTokenPopup - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createPopupClient(t).acquireToken(e);throw this.getBrowserStorage().setInteractionInProgress(!1),n}):o=this.createPopupClient(t).acquireToken(e),o.then(n=>(i.length<this.getAllAccounts().length?this.eventHandler.emitEvent(v.LOGIN_SUCCESS,u.Popup,n):this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_SUCCESS,u.Popup,n),r.add({accessTokenSize:n.accessToken.length,idTokenSize:n.idToken.length}),r.end({success:!0,requestId:n.requestId}),n)).catch(n=>(i.length>0?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,u.Popup,null,n):this.eventHandler.emitEvent(v.LOGIN_FAILURE,u.Popup,null,n),r.end({errorCode:n.errorCode,subErrorCode:n.subError,success:!1}),Promise.reject(n)))}trackPageVisibilityWithMeasurement(){let e=this.ssoSilentMeasurement||this.acquireTokenByCodeAsyncMeasurement;e&&(this.logger.info("Perf: Visibility change detected in ",e.event.name),e.increment({visibilityChangeCount:1}))}ssoSilent(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e),r=w(f({},e),{prompt:e.prompt,correlationId:t});this.preflightBrowserEnvironmentCheck(u.Silent),this.ssoSilentMeasurement=this.performanceClient.startMeasurement(h.SsoSilent,t),this.ssoSilentMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement),this.logger.verbose("ssoSilent called",t),this.eventHandler.emitEvent(v.SSO_SILENT_START,u.Silent,r);let i;return this.canUseNative(r)?i=this.acquireTokenNative(r,T.ssoSilent).catch(o=>{if(o instanceof $&&re(o))return this.nativeExtensionProvider=void 0,this.createSilentIframeClient(r.correlationId).acquireToken(r);throw o}):i=this.createSilentIframeClient(r.correlationId).acquireToken(r),i.then(o=>(this.eventHandler.emitEvent(v.SSO_SILENT_SUCCESS,u.Silent,o),this.ssoSilentMeasurement?.add({accessTokenSize:o.accessToken.length,idTokenSize:o.idToken.length}),this.ssoSilentMeasurement?.end({success:!0,isNativeBroker:o.fromNativeBroker,requestId:o.requestId}),o)).catch(o=>{throw this.eventHandler.emitEvent(v.SSO_SILENT_FAILURE,u.Silent,null,o),this.ssoSilentMeasurement?.end({errorCode:o.errorCode,subErrorCode:o.subError,success:!1}),o}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})})}acquireTokenByCode(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);this.preflightBrowserEnvironmentCheck(u.Silent),this.logger.trace("acquireTokenByCode called",t),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_START,u.Silent,e);let r=this.performanceClient.startMeasurement(h.AcquireTokenByCode,t);try{if(e.code&&e.nativeAccountId)throw g(lr);if(e.code){let i=e.code,o=this.hybridAuthCodeResponses.get(i);return o?(this.logger.verbose("Existing acquireTokenByCode request found",t),r.discard()):(this.logger.verbose("Initiating new acquireTokenByCode request",t),o=this.acquireTokenByCodeAsync(w(f({},e),{correlationId:t})).then(n=>(this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_SUCCESS,u.Silent,n),this.hybridAuthCodeResponses.delete(i),r.add({accessTokenSize:n.accessToken.length,idTokenSize:n.idToken.length}),r.end({success:!0,isNativeBroker:n.fromNativeBroker,requestId:n.requestId}),n)).catch(n=>{throw this.hybridAuthCodeResponses.delete(i),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_FAILURE,u.Silent,null,n),r.end({errorCode:n.errorCode,subErrorCode:n.subError,success:!1}),n}),this.hybridAuthCodeResponses.set(i,o)),yield o}else if(e.nativeAccountId){if(this.canUseNative(e,e.nativeAccountId))return yield this.acquireTokenNative(w(f({},e),{correlationId:t}),T.acquireTokenByCode,e.nativeAccountId).catch(i=>{throw i instanceof $&&re(i)&&(this.nativeExtensionProvider=void 0),i});throw g(dr)}else throw g(hr)}catch(i){throw this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_FAILURE,u.Silent,null,i),r.end({errorCode:i instanceof k&&i.errorCode||void 0,subErrorCode:i instanceof k&&i.subError||void 0,success:!1}),i}})}acquireTokenByCodeAsync(e){return d(this,null,function*(){return this.logger.trace("acquireTokenByCodeAsync called",e.correlationId),this.acquireTokenByCodeAsyncMeasurement=this.performanceClient.startMeasurement(h.AcquireTokenByCodeAsync,e.correlationId),this.acquireTokenByCodeAsyncMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement),yield this.createSilentAuthCodeClient(e.correlationId).acquireToken(e).then(i=>(this.acquireTokenByCodeAsyncMeasurement?.end({success:!0,fromCache:i.fromCache,isNativeBroker:i.fromNativeBroker,requestId:i.requestId}),i)).catch(i=>{throw this.acquireTokenByCodeAsyncMeasurement?.end({errorCode:i.errorCode,subErrorCode:i.subError,success:!1}),i}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})})}acquireTokenFromCache(e,t,r){return d(this,null,function*(){switch(this.performanceClient.addQueueMeasurement(h.AcquireTokenFromCache,t.correlationId),r){case x.Default:case x.AccessToken:case x.AccessTokenAndRefreshToken:return m(e.acquireToken.bind(e),h.SilentCacheClientAcquireToken,this.logger,this.performanceClient,t.correlationId)(t);default:throw O(M.tokenRefreshRequired)}})}acquireTokenByRefreshToken(e,t){return d(this,null,function*(){switch(this.performanceClient.addQueueMeasurement(h.AcquireTokenByRefreshToken,e.correlationId),t){case x.Default:case x.AccessTokenAndRefreshToken:case x.RefreshToken:case x.RefreshTokenAndNetwork:let r=this.createSilentRefreshClient(e.correlationId);return m(r.acquireToken.bind(r),h.SilentRefreshClientAcquireToken,this.logger,this.performanceClient,e.correlationId)(e);default:throw O(M.tokenRefreshRequired)}})}acquireTokenBySilentIframe(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.AcquireTokenBySilentIframe,e.correlationId);let t=this.createSilentIframeClient(e.correlationId);return m(t.acquireToken.bind(t),h.SilentIframeClientAcquireToken,this.logger,this.performanceClient,e.correlationId)(e)})}logout(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.logger.warning("logout API is deprecated and will be removed in msal-browser v3.0.0. Use logoutRedirect instead.",t),this.logoutRedirect(f({correlationId:t},e))})}logoutRedirect(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.preflightBrowserEnvironmentCheck(u.Redirect),this.createRedirectClient(t).logout(e)})}logoutPopup(e){try{let t=this.getRequestCorrelationId(e);return this.preflightBrowserEnvironmentCheck(u.Popup),this.createPopupClient(t).logout(e)}catch(t){return Promise.reject(t)}}clearCache(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.createSilentCacheClient(t).logout(e)})}getAllAccounts(e){return this.logger.verbose("getAllAccounts called"),this.isBrowserEnvironment?this.browserStorage.getAllAccounts(e):[]}getAccount(e){if(this.logger.trace("getAccount called"),Object.keys(e).length===0)return this.logger.warning("getAccount: No accountFilter provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy(e);return t?(this.logger.verbose("getAccount: Account matching provided filter found, returning"),t):(this.logger.verbose("getAccount: No matching account found, returning null"),null)}getAccountByUsername(e){if(this.logger.trace("getAccountByUsername called"),!e)return this.logger.warning("getAccountByUsername: No username provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy({username:e});return t?(this.logger.verbose("getAccountByUsername: Account matching username found, returning"),this.logger.verbosePii(`getAccountByUsername: Returning signed-in accounts matching username: ${e}`),t):(this.logger.verbose("getAccountByUsername: No matching account found, returning null"),null)}getAccountByHomeId(e){if(this.logger.trace("getAccountByHomeId called"),!e)return this.logger.warning("getAccountByHomeId: No homeAccountId provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy({homeAccountId:e});return t?(this.logger.verbose("getAccountByHomeId: Account matching homeAccountId found, returning"),this.logger.verbosePii(`getAccountByHomeId: Returning signed-in accounts matching homeAccountId: ${e}`),t):(this.logger.verbose("getAccountByHomeId: No matching account found, returning null"),null)}getAccountByLocalId(e){if(this.logger.trace("getAccountByLocalId called"),!e)return this.logger.warning("getAccountByLocalId: No localAccountId provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy({localAccountId:e});return t?(this.logger.verbose("getAccountByLocalId: Account matching localAccountId found, returning"),this.logger.verbosePii(`getAccountByLocalId: Returning signed-in accounts matching localAccountId: ${e}`),t):(this.logger.verbose("getAccountByLocalId: No matching account found, returning null"),null)}setActiveAccount(e){this.browserStorage.setActiveAccount(e)}getActiveAccount(){return this.browserStorage.getActiveAccount()}hydrateCache(e,t){return d(this,null,function*(){this.logger.verbose("hydrateCache called");let r=H.createFromAccountInfo(e.account,e.cloudGraphHostName,e.msGraphHost);return this.browserStorage.setAccount(r),e.fromNativeBroker?(this.logger.verbose("Response was from native broker, storing in-memory"),this.nativeInternalStorage.hydrateCache(e,t)):this.browserStorage.hydrateCache(e,t)})}preflightBrowserEnvironmentCheck(e,t=!1){if(this.logger.verbose("preflightBrowserEnvironmentCheck started"),kt(this.isBrowserEnvironment),Et(e,this.config.system.allowRedirectInIframe),ke(),Rt(),Ve(this.initialized),e===u.Redirect&&this.config.cache.cacheLocation===E.MemoryStorage&&!this.config.cache.storeAuthStateInCookie)throw $e(fe);(e===u.Redirect||e===u.Popup)&&this.preflightInteractiveRequest(!t)}preflightInteractiveRequest(e){this.logger.verbose("preflightInteractiveRequest called, validating app environment"),ke(),e&&this.getBrowserStorage().setInteractionInProgress(!0)}acquireTokenNative(e,t,r){return d(this,null,function*(){if(this.logger.trace("acquireTokenNative called"),!this.nativeExtensionProvider)throw g(te);return new F(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,t,this.performanceClient,this.nativeExtensionProvider,r||this.getNativeAccountId(e),this.nativeInternalStorage,e.correlationId).acquireToken(e)})}canUseNative(e,t){if(this.logger.trace("canUseNative called"),!D.isNativeAvailable(this.config,this.logger,this.nativeExtensionProvider,e.authenticationScheme))return this.logger.trace("canUseNative: isNativeAvailable returned false, returning false"),!1;if(e.prompt)switch(e.prompt){case _.NONE:case _.CONSENT:case _.LOGIN:this.logger.trace("canUseNative: prompt is compatible with native flow");break;default:return this.logger.trace(`canUseNative: prompt = ${e.prompt} is not compatible with native flow, returning false`),!1}return!t&&!this.getNativeAccountId(e)?(this.logger.trace("canUseNative: nativeAccountId is not available, returning false"),!1):!0}getNativeAccountId(e){let t=e.account||this.getAccount({loginHint:e.loginHint,sid:e.sid})||this.getActiveAccount();return t&&t.nativeAccountId||""}createPopupClient(e){return new Je(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.nativeExtensionProvider,e)}createRedirectClient(e){return new je(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.nativeExtensionProvider,e)}createSilentIframeClient(e){return new tt(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,T.ssoSilent,this.performanceClient,this.nativeInternalStorage,this.nativeExtensionProvider,e)}createSilentCacheClient(e){return new ye(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeExtensionProvider,e)}createSilentRefreshClient(e){return new rt(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeExtensionProvider,e)}createSilentAuthCodeClient(e){return new nt(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,T.acquireTokenByCode,this.performanceClient,this.nativeExtensionProvider,e)}addEventCallback(e){return this.eventHandler.addEventCallback(e)}removeEventCallback(e){this.eventHandler.removeEventCallback(e)}addPerformanceCallback(e){return this.performanceClient.addPerformanceCallback(e)}removePerformanceCallback(e){return this.performanceClient.removePerformanceCallback(e)}enableAccountStorageEvents(){this.eventHandler.enableAccountStorageEvents()}disableAccountStorageEvents(){this.eventHandler.disableAccountStorageEvents()}getTokenCache(){return this.tokenCache}getLogger(){return this.logger}setLogger(e){this.logger=e}initializeWrapperLibrary(e,t){this.browserStorage.setWrapperMetadata(e,t)}setNavigationClient(e){this.navigationClient=e}getConfiguration(){return this.config}getPerformanceClient(){return this.performanceClient}getBrowserStorage(){return this.browserStorage}isBrowserEnv(){return this.isBrowserEnvironment}getEventHandler(){return this.eventHandler}getRequestCorrelationId(e){return e?.correlationId?e.correlationId:this.isBrowserEnvironment?W():p.EMPTY_STRING}loginRedirect(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.logger.verbose("loginRedirect called",t),this.acquireTokenRedirect(f({correlationId:t},e||vt))})}loginPopup(e){let t=this.getRequestCorrelationId(e);return this.logger.verbose("loginPopup called",t),this.acquireTokenPopup(f({correlationId:t},e||vt))}acquireTokenSilent(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e),r=this.performanceClient.startMeasurement(h.AcquireTokenSilent,t);r.add({cacheLookupPolicy:e.cacheLookupPolicy}),this.preflightBrowserEnvironmentCheck(u.Silent),this.logger.verbose("acquireTokenSilent called",t);let i=e.account||this.getActiveAccount();if(!i)throw g(er);let o={clientId:this.config.auth.clientId,authority:e.authority||p.EMPTY_STRING,scopes:e.scopes,homeAccountIdentifier:i.homeAccountId,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid,shrOptions:e.shrOptions},n=JSON.stringify(o),s=this.activeSilentTokenRequests.get(n);if(typeof s>"u"){this.logger.verbose("acquireTokenSilent called for the first time, storing active request",t);let c=m(this.acquireTokenSilentAsync.bind(this),h.AcquireTokenSilentAsync,this.logger,this.performanceClient,t)(w(f({},e),{correlationId:t}),i).then(l=>(this.activeSilentTokenRequests.delete(n),r.add({accessTokenSize:l.accessToken.length,idTokenSize:l.idToken.length}),r.end({success:!0,fromCache:l.fromCache,isNativeBroker:l.fromNativeBroker,cacheLookupPolicy:e.cacheLookupPolicy,requestId:l.requestId}),l)).catch(l=>{throw this.activeSilentTokenRequests.delete(n),r.end({errorCode:l.errorCode,subErrorCode:l.subError,success:!1}),l});return this.activeSilentTokenRequests.set(n,c),c}else return this.logger.verbose("acquireTokenSilent has been called previously, returning the result from the first call",t),r.discard(),s})}acquireTokenSilentAsync(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.AcquireTokenSilentAsync,e.correlationId),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_START,u.Silent,e),this.atsAsyncMeasurement=this.performanceClient.startMeasurement(h.AcquireTokenSilentAsync,e.correlationId),this.atsAsyncMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibility);let r;if(D.isNativeAvailable(this.config,this.logger,this.nativeExtensionProvider,e.authenticationScheme)&&t.nativeAccountId){this.logger.verbose("acquireTokenSilent - attempting to acquire token from native platform");let i=w(f({},e),{account:t});r=this.acquireTokenNative(i,T.acquireTokenSilent_silentFlow).catch(o=>d(this,null,function*(){if(o instanceof $&&re(o))return this.logger.verbose("acquireTokenSilent - native platform unavailable, falling back to web flow"),this.nativeExtensionProvider=void 0,this.createSilentIframeClient(e.correlationId).acquireToken(e);throw o}))}else{this.logger.verbose("acquireTokenSilent - attempting to acquire token from web flow");let i=this.createSilentCacheClient(e.correlationId),o=yield m(i.initializeSilentRequest.bind(i),h.InitializeSilentRequest,this.logger,this.performanceClient,e.correlationId)(e,t),n=e.cacheLookupPolicy||x.Default;r=m(this.acquireTokenFromCache.bind(this),h.AcquireTokenFromCache,this.logger,this.performanceClient,o.correlationId)(i,o,n).catch(s=>{if(e.cacheLookupPolicy===x.AccessToken)throw s;return ke(),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_NETWORK_START,u.Silent,o),m(this.acquireTokenByRefreshToken.bind(this),h.AcquireTokenByRefreshToken,this.logger,this.performanceClient,o.correlationId)(o,n).catch(c=>{let l=!(c instanceof ge)&&(c.errorCode===P.INVALID_GRANT_ERROR||c.errorCode===M.tokenRefreshRequired)||c.errorCode===Le.noTokensFound,C=n===x.Default||n===x.Skip||n===x.RefreshTokenAndNetwork;if(l&&C)return this.logger.verbose("Refresh token expired/invalid or CacheLookupPolicy is set to Skip, attempting acquire token by iframe.",e.correlationId),m(this.acquireTokenBySilentIframe.bind(this),h.AcquireTokenBySilentIframe,this.logger,this.performanceClient,o.correlationId)(o);throw c})})}return r.then(i=>(this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_SUCCESS,u.Silent,i),this.atsAsyncMeasurement?.end({success:!0,fromCache:i.fromCache,isNativeBroker:i.fromNativeBroker,requestId:i.requestId}),i)).catch(i=>{throw this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,u.Silent,null,i),this.atsAsyncMeasurement?.end({errorCode:i.errorCode,subErrorCode:i.subError,success:!1}),i}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibility)})})}};export{Dr as a,Mn as b,Ei as c,Ye as d,wt as e,Ur as f};
